<template>
  <div class="api-doc">
    <div class="api-doc-box">
      <el-button title="导出到postman" size="mini" @click="exportJson">
        {{ $t('button_export') }}
      </el-button>
    </div>
    <iframe src frameborder="0" class="doc-test-iframe" id="docTestIframe"></iframe>
  </div>
</template>

<script>
import APIClient from '@/api/ApiClient'
import axios from 'axios'
export default {
  name: 'ApiDocAndTest',
  data() {
    return {
      openapi: {},
      token: ''
    }
  },
  created() {
    // this.$emit('amount').$attrs.classname.isclass = true
    if (!parseInt(this.$cookie.get('login'))) {
      return this.$router.push({
        path: '/login',
        query: { redirect: '/apiAnalysis' }
      })
    }
  },
  async mounted() {
    try {
      let apiServers = await this.$api('ApiServer').get({
        'filter[where][clientName]': 'Default APIServer'
      })

      if (apiServers.data.length > 0) {
        let defaultCollection = this.$route.query.collection || this.$route.query['id']

        this.apiClient = new APIClient(defaultCollection)
        this.apiClient.setApiServer(apiServers.data[0])

        let openApi = `${apiServers.data[0].clientURI}/openapi.json`
        debugger
        let openApiObj = await axios.get(openApi)

        if (openApiObj) {
          this.openapi = openApiObj.data
        }
        // let token = this.$route.query.token || '';
        let token = await this.apiClient.getAPIServerToken()
        this.token = token

        let url = `${location.protocol}//${location.hostname}:${location.port}/static/explorer/index.html?url=${openApi}&token=${token}#/`

        if (defaultCollection) {
          url = url + defaultCollection
        }

        let ifm = document.getElementById('docTestIframe')
        ifm.src = url
      } else {
        this.$message.error(this.$t('api_server_no_available')) || 'No available API Server'
      }
    } catch (e) {
      console.log(e)
    }
  },
  methods: {
    exportJson() {
      let obj = this.openapi
      let tokenField = {
        in: 'header',
        name: 'access_token',
        schema: {
          type: 'string',
          default: this.token
        }
      }
      if (obj && obj.paths) {
        for (let x in obj.paths) {
          if (obj.paths[x]) {
            for (let y in obj.paths[x]) {
              if (obj.paths[x][y]) {
                if (!obj.paths[x][y].parameters || !Array.isArray(obj.paths[x][y].parameters)) {
                  obj.paths[x][y].parameters = []
                }
                obj.paths[x][y].parameters.push(tokenField)
              }
            }
          }
        }
        let server = window.location.origin
        obj.paths['/oauth/token'] = {
          servers: [{ url: server }],
          post: {
            'x-controller-name': 'oauth',
            'x-operation-name': 'oauth',
            tags: ['oauth'],
            summary: '授权接口',
            responses: {
              200: {
                description:
                  'Object of page data, result.data is AccessToken1 model instances, result.total is model count.',
                content: {
                  'application/json': {
                    schema: {
                      type: 'object',
                      properties: {
                        data: {
                          type: 'array',
                          items: {
                            $ref: '#/components/schemas/AccessToken1'
                          }
                        },
                        total: {
                          type: 'object',
                          properties: {
                            count: {
                              type: 'number'
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            },
            requestBody: {
              description: '',
              content: {
                'application/x-www-form-urlencoded': {
                  schema: {
                    properties: {
                      grant_type: {
                        type: 'String',
                        default: 'client_credentials'
                      },
                      client_id: {
                        type: 'String'
                      },
                      client_secret: {
                        type: 'String'
                      }
                    }
                  }
                }
              }
            }
          }
        }

        let fileName = 'openApi.json'
        let fileString = JSON.stringify(obj)
        let urlObject = window.URL || window.webkitURL || window
        let export_blob = new Blob([fileString])
        let save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a')
        save_link.href = urlObject.createObjectURL(export_blob)
        save_link.download = fileName
        fakeClick(save_link)

        let fakeClick = function (obj) {
          let ev = document.createEvent('MouseEvents')
          ev.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
          obj.dispatchEvent(ev)
        }
      }
    }
  }
}
</script>

<style scoped lang="scss">
.api-doc {
  position: relative;
  height: 100%;
  overflow: hidden !important;
  .api-doc-box {
    position: absolute;
    left: 10px;
    top: 20px;
    width: 50px;
    overflow: hidden;
  }
  .doc-test-iframe {
    min-height: 100%;
    width: 100%;
    padding-left: 60px;
  }
}
</style>
