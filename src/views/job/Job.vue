<template>
  <div class="editor-container" v-loading="loading" style="position: relative">
    <!-- <simpleScene v-if="$route.query.isSimpleScene"></simpleScene> -->
    <simpleScene v-if="isSimple" ref="simpleScene"></simpleScene>
    <newDataFlow v-if="newDataFlowV" ref="newDataFlowV"></newDataFlow>
    <div
      class="action-buttons"
      style="display: flex; align-items: center; justify-content: space-between; padding-right: 10px"
    >
      <div class="backIcon">
        <VIcon @click="backDataFlow" :title="$t('dataFlow.backlistText')">menu</VIcon>
      </div>
      <div class="flex-center">
        <el-button
          v-if="isEditable() && !isMoniting"
          class="action-btn"
          size="mini"
          :loading="isSaving"
          @click="draftSave"
        >
          <VIcon>save</VIcon>
          <span>{{ isSaving ? $t('dataFlow.button.saveing') : $t('dataFlow.button.save') }}</span>
        </el-button>

        <el-autocomplete
          class="inline-input searchNode"
          id="searchNode"
          v-model="state"
          size="mini"
          :fetch-suggestions="querySearch"
          suffix-icon="el-icon-search"
          :placeholder="$t('dataFlow.searchNode')"
          @select="handleSearchNode"
          hide-loading
          clearable
        >
        </el-autocomplete>

        <el-button-group class="action-btn-group">
          <el-button
            v-if="['scheduled', 'running'].includes(status) && executeMode === 'running_debug'"
            class="action-btn"
            size="mini"
            @click="stopCapture"
            :disabled="$disabledByPermission('SYNC_job_operation_all_data', creatUserId)"
            v-readonlybtn="'SYNC_job_operation'"
          >
            <i class="iconfont icon-zanting3"></i>
            <span>{{ $t('dataFlow.button.stop_capture') }}</span>
          </el-button>
          <el-button
            v-readonlybtn="'SYNC_job_operation'"
            :disabled="$disabledByPermission('SYNC_job_operation_all_data', creatUserId)"
            v-if="
              ['running'].includes(status) && executeMode === 'normal' && $window.getSettingByKey('SHOW_DATA_TRACE')
            "
            class="action-btn"
            size="mini"
            @click="capture"
          >
            <i class="iconfont icon-yulan1"></i>
            <span>{{ $t('dataFlow.button.capture') }}</span>
          </el-button>
          <el-button
            v-readonlybtn="'SYNC_job_operation'"
            :disabled="$disabledByPermission('SYNC_job_operation_all_data', creatUserId)"
            v-if="
              statusBtMap[status] && !statusBtMap[status].reloadSchema && !$window.getSettingByKey('DFS_TCM_PLATFORM')
            "
            class="action-btn"
            size="mini"
            @click="reloadSchema"
          >
            <i class="iconfont icon-kujitongbucopy"></i>
            <span>{{ $t('dataFlow.button.reloadSchema') }}</span>
          </el-button>
          <el-button
            v-readonlybtn="'SYNC_job_operation'"
            :disabled="$disabledByPermission('SYNC_job_operation_all_data', creatUserId)"
            v-if="isEditable() && $window.getSettingByKey('SHOW_DATA_TRACE')"
            class="action-btn"
            size="mini"
            @click="preview"
          >
            <i class="iconfont icon-yulan1"></i>
            <span>{{ $t('dataFlow.button.preview') }}</span>
          </el-button>
          <el-button
            class="action-btn"
            size="mini"
            v-if="!$window.getSettingByKey('DFS_TCM_PLATFORM')"
            @click="showLogs"
          >
            <i class="iconfont icon-rizhi1"></i>
            <span>{{ $t('dataFlow.button.logs') }}</span>
          </el-button>
        </el-button-group>

        <el-button
          class="btn-setting"
          size="mini"
          v-if="!$window.getSettingByKey('DFS_TCM_PLATFORM')"
          @click="showSetting"
        >
          <i class="iconfont icon-shezhi1"></i>
          <span class="btn-setting-text">{{
            {
              'initial_sync+cdc': $t('dataFlow.initial_sync') + '+' + $t('dataFlow.cdc'),
              initial_sync: $t('dataFlow.initial_sync'),
              cdc: $t('dataFlow.cdc')
            }[sync_type]
          }}</span>
        </el-button>
      </div>
      <el-tag
        v-if="progress.showProgress"
        effect="plain"
        type="info"
        size="mini"
        style="margin-left: 10px; margin-right: 10px; border: none"
      >
        <span style="display: inline-block; padding: 0 5px; vertical-align: middle"
          >加载进度: {{ progress.finished }} / {{ progress.total }}</span
        >
      </el-tag>
      <div class="flex-center">
        <el-tag
          :type="
            status === 'running' ? 'success' : status === 'error' ? 'danger' : status === 'paused' ? 'warning' : 'info'
          "
          effect="plain"
          size="mini"
          style="margin-left: 30px; margin-right: 10px; border: none"
        >
          <span class="spinner-box">
            <el-image
              v-if="status === 'running'"
              style="width: 15px; height: 15px"
              src="static/editor/running.svg"
            ></el-image>
            <el-image
              v-if="status === 'stopping'"
              style="width: 15px; height: 15px"
              src="static/editor/stopping.svg"
            ></el-image>
            <el-image
              v-if="status === 'scheduled'"
              style="width: 15px; height: 15px"
              src="static/editor/scheduled.svg"
            ></el-image>
          </span>
          <span
            :style="{
              color: status === 'scheduled' ? '#b0e58c' : status === 'stopping' ? '#fccd85' : ''
            }"
            >{{ $t('dataFlow.state') }}:
            <template v-if="status">
              {{ $t('dataFlow.status.' + status.replace(/ /g, '_')) }}
            </template>
          </span>
        </el-tag>

        <el-button-group class="action-btn-group" v-readonlybtn="'SYNC_job_operation'">
          <el-button
            :disabled="
              $disabledByPermission('SYNC_job_operation_all_data', creatUserId) ||
              (statusBtMap[status] && statusBtMap[status].start)
            "
            class="action-btn btn-operatiton"
            size="mini"
            @click="start()"
          >
            <i class="icon-margin-right-5 iconfont icon-yunhang1"></i>
            <span>{{ $t('dataFlow.button.start') }}</span>
          </el-button>
          <el-button
            :disabled="
              $disabledByPermission('SYNC_job_operation_all_data', creatUserId) ||
              (statusBtMap[status] && statusBtMap[status].stop)
            "
            class="action-btn btn-operatiton"
            size="mini"
            @click="stop()"
          >
            <i class="icon-margin-right-5 iconfont icon-zanting2"></i>
            <span>{{ $t('dataFlow.button.stop') }}</span>
          </el-button>
          <el-button
            :disabled="
              $disabledByPermission('SYNC_job_operation_all_data', creatUserId) ||
              (statusBtMap[status] && statusBtMap[status].reset)
            "
            class="action-btn btn-operatiton"
            size="mini"
            @click="reset"
          >
            <i class="icon-margin-right-5 iconfont icon-shuaxin3"></i>
            <span>{{ $t('dataFlow.button.reset') }}</span>
          </el-button>
          <el-button
            :disabled="
              $disabledByPermission('SYNC_job_operation_all_data', creatUserId) ||
              (statusBtMap[status] && statusBtMap[status].forceStop)
            "
            class="action-btn btn-operatiton"
            size="mini"
            @click="stop(true)"
          >
            <i class="icon-margin-right-5 iconfont icon-zanting3"></i>
            <span>{{ $t('dataFlow.button.force_stop') }}</span>
          </el-button>
        </el-button-group>

        <el-button
          v-readonlybtn="'SYNC_job_edition'"
          :disabled="$disabledByPermission('SYNC_job_edition_all_data', creatUserId)"
          v-if="
            statusBtMap[status] &&
            !statusBtMap[status].edit &&
            !editable &&
            !$window.getSettingByKey('DFS_TCM_PLATFORM')
          "
          ff
          class="btn-edit"
          size="mini"
          type="primary"
          @click="setEditable(true)"
        >
          <i class="icon-margin-right-5 iconfont icon-bianji2"></i>
          <span>{{ $t('dataFlow.edit') }}</span>
        </el-button>
      </div>
    </div>

    <el-dialog
      :title="$t('dataFlow.submitConfirmation')"
      custom-class="dialogConfig"
      :visible.sync="dialogFormVisible"
      width="600px"
      :close-on-click-modal="!dialogFormVisible"
    >
      <el-form :model="form" label-position="left">
        <el-form-item :label="$t('dataFlow.taskName')">
          <el-input class="e-input" v-model="form.taskName" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item :label="$t('dataFlow.implementationModalities')">
          <el-select v-model="sync_type" size="mini" disabled>
            <el-option v-for="item in settingList" :key="item.type" :label="item.name" :value="item.type"> </el-option>
          </el-select>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button class="e-button" @click="dialogFormVisible = false">{{ $t('message.cancel') }}</el-button>
        <el-button class="e-button" type="primary" @click="start">{{ $t('dataFlow.submitExecute') }}</el-button>
      </div>
    </el-dialog>
    <el-dialog
      :title="$t('message.prompt')"
      :visible.sync="reloadSchemaDialog"
      :close-on-click-modal="false"
      width="30%"
    >
      <span>{{ $t('editor.ui.allNodeLoadSchemaDiaLog') }}</span>
      <span slot="footer" class="dialog-footer">
        <el-button @click="reloadSchemaDialog = false">{{ $t('message.cancel') }}</el-button>
        <el-button type="primary" @click="confirmReloadSchemaDialog">{{ $t('message.confirm') }}</el-button>
      </span>
    </el-dialog>
    <AddBtnTip v-if="!loading && isEditable() && !$window.getSettingByKey('DFS_TCM_PLATFORM')"></AddBtnTip>
    <DownAgent ref="agentDialog" type="taskRunning" @closeAgentDialog="closeAgentDialog"></DownAgent>
    <SkipError ref="errorHandler" @skip="skipHandler"></SkipError>
    <CheckStage
      v-show="showCheckStagesVisible"
      :visible="showCheckStagesVisible"
      :data="checkStagesData"
      @complete="saveCheckStages"
    ></CheckStage>
    <el-dialog
      title="任务启动预检查未通过"
      :visible.sync="showSchemaProgress"
      :close-on-click-modal="false"
      width="30%"
    >
      <span>错误原因: 模型推演进行中</span>
      <div>当前进度: {{ progress.finished }} / {{ progress.total }}</div>
      <span slot="footer" class="dialog-footer">
        <el-button size="mini" @click="showSchemaProgress = false">关闭</el-button>
        <el-button type="primary" size="mini" @click="start()">重试</el-button>
      </span>
    </el-dialog>
    <el-dialog
      title="任务启动预检查未通过"
      :visible.sync="showFieldMappingProgress"
      :close-on-click-modal="false"
      width="30%"
    >
      <span>错误原因: 字段映射错误请校正</span>
      <span slot="footer" class="dialog-footer">
        <el-button size="mini" @click="showFieldMappingProgress = false">关闭</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
import $ from 'jquery'
import factory from '../../api/factory'
import editor from '../../editor/index'
import breakText from '../../editor/breakText'
import { statusBtMap } from '../../editor/states'
import { db2db } from '../../editor/simpleSceneData'
import log from '../../log'
import ws from '../../api/ws'
import AddBtnTip from './addBtnTip'
import simpleScene from './SimpleScene'
import newDataFlow from '@/components/newDataflowName'
import DownAgent from '../downAgent/agentDown'
import { FORM_DATA_KEY, JOIN_TABLE_TPL, DATABASE_TYPE_MAPPING } from '../../editor/constants'
import { EditorEventType } from '../../editor/lib/events'
import _ from 'lodash'
import SkipError from '../../components/SkipError'
import { uuid } from '../../editor/util/Schema'
import VIcon from '@/components/VIcon'

const dataFlowsApi = factory('DataFlows')
const Setting = factory('Setting')
// const cluster = factory('cluster');
let changeData = null
let timer = null
export default {
  name: 'Job',
  dataFlow: null,
  components: { AddBtnTip, simpleScene, newDataFlow, DownAgent, SkipError, VIcon },
  data() {
    return {
      downLoadNum: 0,
      reloadSchemaDialog: false,
      dialogFormVisible: false,
      form: {
        taskName: '',
        type: this.$t('dataFlow.button.quantitative') + '+' + this.$t('dataFlow.button.increment')
      },

      dataFlowId: null,
      tempKey: 0,
      tempId: false,
      tempData: [],
      status: 'draft',
      executeMode: 'normal',
      isPreview: false, //只有这一个场景需要切换编辑状态

      loading: true,
      cells: [],
      state: '',
      editable: false,
      isMoniting: false,
      isSimple: false,
      newDataFlowV: false,
      isSaving: false,
      sync_type: 'initial_sync+cdc',
      settingList: [
        {
          type: 'initial_sync+cdc',
          name: this.$t('dataFlow.initial_sync') + '+' + this.$t('dataFlow.cdc')
        },
        { type: 'initial_sync', name: this.$t('dataFlow.initial_sync') },
        { type: 'cdc', name: this.$t('dataFlow.cdc') }
      ],
      flowDataName: '',
      mappingTemplate: '',
      creatUserId: '',
      dataChangeFalg: false,
      statusBtMap,
      showCheckStagesVisible: false,
      checkStagesData: [],
      modPipeline: '',
      //schema加载进度
      progress: {
        total: '0',
        finished: '0',
        progress: '0',
        showProgress: false
      },
      showSchemaProgress: false,
      showFieldMappingProgress: false
    }
  },
  watch: {
    status: {
      handler() {
        if (this.isPreview) this.setEditable(this.isEditable())
      }
    }
  },
  mounted() {
    // build editor
    let customProcessors = []
    this.$api('nodeConfigs')
      .get()
      .then(({ data }) => {
        customProcessors = data
        if (this.$route.query.isSimple == 'true') this.isSimple = true
        if (!this.$route.query.id) {
          this.getGlobalSetting()
        }
        this.mappingTemplate = this.$route.query.mapping
        if (this.$route.query.isMoniting == 'true') this.isMoniting = true
        this.editor = editor({
          container: $('.editor-container'),
          actionBarEl: $('.editor-container .action-buttons'),
          scope: this,
          customProcessors
        })

        if (this.$route.query.isSimple == 'true') {
          this.initData(db2db.data)
          this.mappingTemplate = 'cluster-clone'
          this.loading = false
          setTimeout(() => this.initSimple(), 1100)
          return
        }
        if (window.name && window.name.length > 200) {
          this.initData(JSON.parse(window.name))
          window.name = ''
          this.loading = false
          return
        }
        this.loadData()
        if (this.$route.query.id) {
          this.wsWatch()
          this.getSchemaResult()
        }
        this.editor.graph.on(EditorEventType.DRAFT_SAVE, () => {
          this.draftSave()
        })

        window.addEventListener('beforeunload', this.handleBeforeUnLoad)
      })
  },

  methods: {
    // 关闭agent下载弹窗返回参数
    closeAgentDialog() {
      this.start()
    },

    backDataFlow() {
      let mapping = this.$route.query.mapping
      const $PLATFORM = window.getSettingByKey('DFS_TCM_PLATFORM')
      const backToList = () => {
        if ($PLATFORM === 'dfs') {
          top.window.App.$router.push({
            name: 'Task'
          })
        } else {
          this.$router.push({
            name: 'dataFlows',
            query: {
              mapping: mapping
            }
          })
        }
      }
      if (!this.dataChangeFalg || $PLATFORM) {
        backToList()
      } else {
        this.$confirm(this.$t('dataFlow.saveReminder'), this.$t('dataFlow.backlistText'), {
          type: 'warning',
          confirmButtonText: this.$t('dataFlow.leave'),
          closeOnClickModal: false
        }).then(resFlag => {
          if (!resFlag) {
            return
          }
          this.dataChangeFalg = false
          backToList()
        })
      }
    },

    isEditable() {
      return ['draft', 'error', 'paused'].includes(this.status)
    },
    loadData() {
      if (this.$route.query && this.$route.query.id) {
        this.loadDataFlow(this.$route.query.id)
      } else {
        this.loading = false
        this.onGraphChanged()
        this.setEditable(true)
        this.creatUserId = this.$cookie.get('user_id')
        this.editor.ui.setName(this.$t('dataFlow.newTaksName') + '_' + uuid().slice(0, 7))
        // if (!this.dataFlow) document.title = this.$t('dataFlow.newTaksName');
      }
      this.setSelector(this.$route.query.mapping)
    },

    simpleRefresh() {
      let self = this
      self.editor.graph.paper.getMountedViews().forEach(ele => {
        if (ele.$el) ele.$el.show()
      })
      this.$nextTick(() => {
        self.$refs.simpleScene.cellHtml = self.editor.graph.paper
          .getMountedViews()
          .map(ele => {
            if (ele.model.isElement) return ele.$el[0].outerHTML
            else return ''
          })
          .join('')
        self.$refs.simpleScene.renderCell()
        self.editor.graph.paper.getMountedViews().forEach(ele => {
          if (ele.$el) ele.$el.hide()
        })
        try {
          if (this.editor.graph.graph.getCells()[self.$refs.simpleScene.activeStep - 1].validate())
            self.$refs.simpleScene.stepValid()
        } catch (e) {
          log(e.message)
        }
      })
    },
    simpleGoNext(step) {
      let self = this
      if (step == 4) {
        this.newDataFlowV = true
        if (this.$refs.newDataFlowV) this.$refs.newDataFlowV.dialogVisibleSetting = true
        return
      } else this.newDataFlowV = false
      this.editor.graph.selectCell(this.editor.graph.graph.getCells()[step - 1])
      setTimeout(() => {
        self.simpleRefresh()
      }, 10)
    },
    initSimple() {
      let self = this
      this.editor.graph.isSimple = true
      document.body.getElementsByClassName('e-sidebar-right')[0].style.zIndex = 2000
      this.editor.graph.selectCell(this.editor.graph.graph.getCells()[0])
      setTimeout(() => {
        self.simpleRefresh()
      }, 10)
    },
    initData(data) {
      let dataFlow = data
      this.dataFlowId = dataFlow.id
      this.status = dataFlow.status
      this.executeMode = dataFlow.executeMode
      if (dataFlow.setting) {
        this.sync_type = dataFlow.setting.sync_type
      }
      this.dataFlow = dataFlow
      if (!dataFlow.name) {
        dataFlow.name = this.$t('dataFlow.newTaksName') + '_' + uuid().slice(0, 7)
      }
      document.title = dataFlow.name
      // 管理端api创建任务来源以及editorData 数据丢失情况
      if (!dataFlow.editorData && dataFlow.stages) {
        // 1. 拿到创建所有的节点数据
        let cells = JSON.stringify(this.creatApiEditorData(dataFlow.stages))
        dataFlow.editorData = cells
        // 2. 调用画布创建节点方法
        this.editor.setData(dataFlow)
        // 3. 更新schema
        this.editor.reloadSchema()
        // 4. 节点布局
        this.editor.graph.layoutDirectedGraph()
        // 5. 处理joinTables
        this.handleJoinTables(dataFlow.stages, this.editor.graph.graph)
      } else {
        this.editor.setData(dataFlow)
      }
      if (this.statusBtMap[this.status].start || this.isMoniting) this.setEditable(false)
      else this.setEditable(true)
      if (this.executeMode !== 'normal') this.showCapture()
      this.onGraphChanged()
      this.setSelector(this.$route.query.mapping)
      this.editor.graph.setSettingData(dataFlow.setting)
      this.wsSend()
      let self = this
      setTimeout(() => {
        self.dataChangeFalg = false
      }, 100)
    },
    wsSend() {
      if (this.dataFlowId) {
        let msg = {
          type: 'watch',
          collection: 'DataFlows',
          filter: {
            where: { 'fullDocument._id': { $in: [this.dataFlowId] } }, //查询条件
            fields: {
              'fullDocument.id': true,
              'fullDocument.name': true,
              'fullDocument.status': true,
              'fullDocument.executeMode': true,
              'fullDocument.stopOnError': true,
              'fullDocument.last_updated': true,
              'fullDocument.createTime': true,
              'fullDocument.children': true,
              'fullDocument.stats': true,
              'fullDocument.setting': true,
              'fullDocument.cdcLastTimes': true,
              'fullDocument.listtags': true,
              'fullDocument.finishTime': true,
              'fullDocument.startTime': true,
              'fullDocument.errorEvents': true,
              'fullDocument.milestones': true
            }
          }
        }
        ws.ready(() => {
          ws.send(msg)
        }, true)
      }
    },
    wsWatch() {
      let self = this
      ws.on('watch', function (data) {
        let dat = data.data.fullDocument
        self.status = dat.status

        if (self.executeMode !== dat.executeMode) self.executeMode = dat.executeMode

        if (!self.statusBtMap[self.status].start) {
          self.executeMode = 'normal'
        }
        delete self.dataFlow.validateBatchId
        delete self.dataFlow.validateStatus
        delete self.dataFlow.validationSettings

        Object.assign(self.dataFlow, dat)
        self.editor.emit('dataFlow:updated', _.cloneDeep(dat))
      })
      if (timer && !this.dataFlowId) return
      timer = setInterval(() => {
        self.updateDataFlow()
      }, 5000)
    },
    //实时获取schema加载进度
    initWSSed(id) {
      let msg = {
        dataFlowId: id,
        stageId: this.stageId
      }
      ws.ready(() => {
        ws.send(msg)
      }, true)
    },
    getSchemaResult() {
      let self = this
      ws.on('metadataTransformerProgress', function (res) {
        if (!res?.data?.stageId) {
          let { finished, total, status } = res?.data
          self.progress.finished = finished
          self.progress.total = total
          self.progress.progress = status
          if (status !== 'done') {
            self.progress.showProgress = true
          } else {
            self.progress.showProgress = false
          }
        }
      })
    },
    updateDataFlow() {
      let self = this
      let id = self.$route.query.id
      dataFlowsApi.get([id]).then(result => {
        let dat = result?.data || {}
        self.status = dat.status

        if (self.executeMode !== dat.executeMode) self.executeMode = dat.executeMode

        if (self.statusBtMap[self.status] && !self.statusBtMap[self.status].start) {
          self.executeMode = 'normal'
        }
        if (self.dataFlow) {
          delete self.dataFlow.validateBatchId
          delete self.dataFlow.validateStatus
          delete self.dataFlow.validationSettings
          Object.assign(self.dataFlow, dat)
        }
        self.editor.emit('dataFlow:updated', _.cloneDeep(dat))
      })
    },
    onGraphChanged() {
      if (this.isSimple) {
        this.editor.graph.on(EditorEventType.DATAFLOW_CHANGED, () => {
          this.simpleRefresh()
        })
        return
      }
      let self = this
      this.editor.graph.on(EditorEventType.DATAFLOW_CHANGED, () => {
        changeData = this.getDataFlowData(true)
        if (changeData) {
          self.dataChangeFalg = true
        }
      })
    },
    //点击draft save按钮
    async draftSave() {
      this.isSaving = true
      localStorage.removeItem(this.tempId)
      let self = this,
        promise = null,
        // lastString = '',
        data = this.getDataFlowData(true)

      let params = {
        'filter[order]': 'name DESC',
        'filter[limit]': 1,
        'filter[where][name][like]': data.name
      }

      let result = await dataFlowsApi.get(params)
      if (result && result.data.length > 0) {
        this.flowDataName = result.data[0].name
      }

      log('DataFlows Draft Save Params: ', data)
      if (data?.stages?.length) {
        data.stages.forEach(item => {
          // 是否有hive
          if (item.type === 'hive' || item.database_type === 'hive') {
            data.setting.transformerConcurrency = 1
            data.setting.readBatchSize = 10000
          }
        })
      }
      promise = dataFlowsApi.draft(data)

      if (promise) {
        promise
          .catch(e => {
            if (e.response.msg === 'duplication for names') {
              self.$message.error(self.$t('message.exists_name'))
            } else {
              self.$message.error(self.$t('message.saveFail'))
            }
          })
          .then(result => {
            if (result && result.data) {
              let dataFlow = result.data
              self.dataFlowId = dataFlow.id
              self.status = dataFlow.status
              self.executeMode = dataFlow.executeMode
              self.dataFlow = dataFlow
              if (!self.$route.query || !self.$route.query.id) {
                self.$router.push({
                  name: 'job',
                  query: {
                    id: dataFlow.id,
                    mapping: this.mappingTemplate
                  }
                })
              }
              self.$message.success(self.$t('message.saveOK'))
            }
            log('DataFlows Draft Save Response: ', result)
          })
          .finally(() => {
            changeData = null
            self.loading = false
            self.isSaving = false
          })
      }
    },

    /**
     * show submit layer
     */
    submitLayer() {
      this.dialogFormVisible = true
      if (this.dialogFormVisible) {
        let editorData = this.editor.getData()
        this.form.taskName = editorData.name
      }
    },

    /**
     * load data flow by id
     * @param id
     */
    loadDataFlow(id) {
      let self = this
      dataFlowsApi
        .get([id])
        .then(result => {
          if (result && result.data) {
            self.creatUserId = result.data.user_id
            self.initData(result.data)
            // 删除旧缓存
            Object.keys(localStorage).forEach(key => {
              if (key.startsWith('tapdata.dataflow.$$$') && key.split('$$$')[2] == result.data.name)
                try {
                  if (JSON.parse(localStorage.getItem(key)).id == result.data.id) localStorage.removeItem(key)
                } catch (e) {
                  localStorage.removeItem(key)
                }
            })
          } else {
            self.$message.error(self.$t('message.api.get.error'))
            self.setEditable(false)
          }
          self.loading = false
        })
        .catch(err => {
          log(err)
          self.$message.error(self.$t('message.api.get.error'))
          self.loading = false
        })
    },

    /**
     * get editor data
     * @return {{name: *, description: string, status: string, executeMode: string, category: string, stopOnError: boolean, mappingTemplate: string, emailWaring: {edited: boolean, started: boolean, error: boolean, paused: boolean}, stages: Array, setting: *} & {editorData: string}}
     */
    getDataFlowData(autoSave) {
      // validate
      if (!autoSave) {
        this.editor.graph.unHighlightAllCells()
        let verified = this.editor.validate()
        if (verified !== true) {
          this.$message.error(verified)
          return
        }
      }
      let editorData = this.editor.getData()
      let graphData = editorData.graphData
      let settingData = editorData.settingData
      this.sync_type = settingData.sync_type
      settingData.notificationInterval = settingData.notificationInterval
        ? Number(settingData.notificationInterval)
        : 300
      settingData.notificationWindow = settingData.notificationWindow ? Number(settingData.notificationWindow) : 0
      settingData.readBatchSize = settingData.readBatchSize ? Number(settingData.readBatchSize) : 1000
      settingData.readCdcInterval = settingData.readCdcInterval ? Number(settingData.readCdcInterval) : 500
      settingData.transformerConcurrency = settingData.transformerConcurrency
        ? Number(settingData.transformerConcurrency)
        : 8
      settingData.processorConcurrency = settingData.processorConcurrency ? Number(settingData.processorConcurrency) : 1
      settingData.userSetLagTime = settingData.userSetLagTime ? Number(settingData.userSetLagTime) : 0
      let distanceForSink = editorData.distanceForSink || {}

      let cells = graphData.cells ? graphData.cells : []
      let edgeCells = {}
      let nodeCells = {}
      cells.forEach(cell => {
        if (cell.type === 'app.Link' || cell.type === 'app.databaseLink') {
          if (cell.attrs && cell.attrs.line && cell.attrs.line.stroke) {
            cell.attrs.line.stroke = '#8f8f8f' // 鼠标未失去焦点就保存，针对link选中状态改为默认
          }
          edgeCells[cell.id] = cell
        } else nodeCells[cell.id] = cell
      })

      let postData = Object.assign(
        {
          name: editorData.name.trim(),
          description: '',
          status: this.status || 'draft',
          executeMode: this.executeMode || 'normal',
          category: '数据库克隆',
          stopOnError: false,
          mappingTemplate: this.mappingTemplate,
          emailWaring: {
            edited: true,
            started: false,
            error: true,
            paused: false
          },
          stages: [],
          setting: settingData
        },
        {
          editorData: JSON.stringify(graphData)
        }
      )
      let stages = {}
      Object.values(nodeCells).forEach(cell => {
        let stage = (stages[cell.id] = Object.assign(
          {
            id: cell.id,
            inputLanes: [],
            outputLanes: [],
            // syncType: "initial_sync+cdc",
            distance: distanceForSink[cell.id]
          },
          cell[FORM_DATA_KEY] || {}
        ))

        if (['app.Database'].includes(cell.type)) {
          postData.mappingTemplate = 'cluster-clone'

          Object.assign(stage, {
            type: 'database',
            readCdcInterval: 500,
            readBatchSize: 1000
          })
        } else if (
          [
            'app.Table',
            'app.Collection',
            'app.ESNode',
            'app.HiveNode',
            'app.KUDUNode',
            'app.HanaNode',
            'app.ClickHouse',
            'app.DamengNode'
          ].includes(cell.type)
        ) {
          postData.mappingTemplate = 'custom'

          Object.assign(stage, {
            dataQualityTag: false,
            joinTables: Object.values(edgeCells)
              .filter(edge => edge.target && edge.target.id === cell.id)
              .map(edge => edge[FORM_DATA_KEY] && edge[FORM_DATA_KEY].joinTable)
          })
        }
      })
      Object.values(edgeCells).forEach(cell => {
        if (cell.type === 'app.Link' || cell.type === 'app.databaseLink') {
          let sourceId = cell.source.id
          let targetId = cell.target.id
          if (sourceId && stages[sourceId]) {
            stages[sourceId].outputLanes.push(targetId)
            //添加字段处理器
            if (postData.mappingTemplate === 'cluster-clone') {
              stages[sourceId]['field_process'] = cell[FORM_DATA_KEY]?.field_process

              //迁移全局修改设置值
              stages[targetId].tableNameTransform = cell[FORM_DATA_KEY]?.tableNameTransform
              stages[targetId].fieldsNameTransform = cell[FORM_DATA_KEY]?.fieldsNameTransform
            }
          }
          if (targetId && stages[targetId]) {
            stages[targetId].inputLanes.push(sourceId)
          }
        }
      })
      postData.stages = Object.values(stages)

      if (this.dataFlowId) postData.id = this.dataFlowId

      return postData
    },

    /**
     * get data flow stage and include inputSchema, outputSchema, schema
     */
    getStages() {
      let dataFlowData = this.getDataFlowData(true)
      let stages = dataFlowData.stages
      let { graph } = this.editor.getData() || {}
      let dataFlowId = this.dataFlowId
      stages.forEach(stage => {
        let cell = graph.getCell(stage.id) || {}
        let schema = cell.getSchema()
        let outputSchema = cell.getOutputSchema()
        let inputSchema = cell.getInputSchema()
        if (schema) stage.schema = schema
        if (outputSchema) stage.outputSchema = outputSchema
        if (inputSchema) stage.inputSchema = inputSchema

        stage.dataFlowId = dataFlowId
      })
      return stages
    },
    checkJoinTableStageId() {
      let stages = this.getDataFlowData(true).stages
      let cells = this.editor.graph.graph.getCells()
      let valid = true
      stages.forEach(stage => {
        if (stage.joinTables)
          stage.joinTables.forEach(jt => {
            if (!jt || !jt.id) return
            let finded = false
            cells.reduce((finded, cell) => {
              if (cell.id == jt.id) finded = true
            })
            try {
              if (!finded) cells.filter(cell => cell.id == stage.id)[0].updateOutputSchema()
            } catch (e) {
              alert('jointables stageid chaeck failed===>>' + stage.id)
              valid = false
            }
          })
      })
      return valid
    },

    /**
     * request server do save data flow
     * @param data
     * @param cb
     */
    doSave(data, cb) {
      let self = this
      if (!this.checkJoinTableStageId()) return
      localStorage.removeItem(this.tempId)
      const _doSave = function () {
        let promise = data.id ? dataFlowsApi.patch(data) : dataFlowsApi.post(data)

        promise
          .then(result => {
            if (result && result.data) {
              let dataFlow = result.data

              self.dataFlowId = dataFlow.id
              self.status = dataFlow.status
              self.executeMode = dataFlow.executeMode

              self.dataFlow = dataFlow

              if (typeof cb === 'function') {
                cb(null, dataFlow)
              }

              let stages = self.getStages()
              dataFlowsApi
                .saveStage(stages)
                .then(() => {
                  if (!self.$route.query || !self.$route.query.id) {
                    self.$router.push({
                      name: 'job',
                      query: {
                        id: dataFlow.id,
                        mapping: this.mappingTemplate
                      }
                    })
                    self.wsWatch()
                    self.wsSend()
                  }
                })
                .catch(() => {
                  self.$message.error(self.$t('message.saveFail'))
                })
            } else {
              if (typeof cb === 'function') {
                cb(result, null)
              }
            }
            self.loading = false
          })
          .catch(e => {
            self.loading = false
            if (typeof cb === 'function') {
              cb(e, null)
            }
          })
      }

      if (data.name) {
        let params = {
          name: data.name,
          user_id: this.dataFlow?.user_id || data.user_id || ''
        }
        if (data.id) {
          params.id = {
            neq: data.id
          }
        }
        self.loading = true
        dataFlowsApi
          .count({ where: JSON.stringify(params) })
          .then(result => {
            if (result && result.data && result.data.count > 0) {
              this.$message.error(`${self.$t('message.exists_name')}: ${data.name}`)
              self.loading = false
            } else {
              _doSave()
            }
          })
          .catch(e => {
            self.loading = false
            if (typeof cb === 'function') {
              cb(e, null)
            }
          })
      } else {
        _doSave()
      }
    },

    /**
     * save button handler
     */
    save() {
      let self = this,
        data = this.getDataFlowData()
      if (data) {
        if (data.id) delete data.status

        self.doSave(data, err => {
          if (err) {
            this.$message.error(self.$t('message.saveFail'))
          } else {
            this.$message.success(self.$t('message.saveOK'))
          }
        })
      }
    },
    skipHandler(id, errorEvents) {
      let data = this.getDataFlowData()
      if (data) {
        data.errorEvents = errorEvents
        this.doSaveStartDataFlow(data)
      }
    },
    checkAgentStatus(callback) {
      if (window.getSettingByKey('DFS_TCM_PLATFORM') === 'dfs') {
        this.$api('tcm')
          .getAgentCount()
          .then(res => {
            if (res?.data?.agentRunningCount > 0) {
              callback && callback()
            } else {
              this.$message.error('Agent当前状态异常，请检查')
            }
          })
      } else {
        callback && callback()
      }
    },
    /**
     * start button handler
     */
    async start() {
      let _this = this
      let id = this.$route.query.id

      if (this.$refs.agentDialog.checkAgent()) {
        this.checkAgentStatus(() => {
          let doStart = () => {
            let data = this.$route.query.isMoniting ? this.dataFlow : this.getDataFlowData() //监控模式启动任务 data 为接口请求回来数据 编辑模式为cell 组装数据
            if (data) {
              this.doSaveStartDataFlow(data)
            }
          }
          let filter = {
            where: {
              'contextMap.dataFlowId': {
                eq: id
              },
              level: 'ERROR'
            }
          }
          if (id) {
            _this
              .$api('logs')
              .get({ filter: JSON.stringify(filter) })
              .then(res => {
                if (res.data?.length && this.$route.query && id) {
                  _this.$refs.errorHandler.checkError({ id, status: this.status }, () => {
                    doStart()
                  })
                } else {
                  doStart()
                }
              })
          } else {
            doStart()
          }
        })
        // if (this.$route.query && id) {
        //   this.$refs.errorHandler.checkError(
        //     { id, status: this.status },
        //     () => {
        //       doStart()
        //     }
        //   )
        // } else {
        //   doStart()
        // }
      }
    },
    //保存逻辑启动
    async doSaveStartDataFlow(data) {
      if (data) {
        if (this.form.taskName) {
          data.name = this.form.taskName
        }
        // 数据库节点连线至少保留一张表开始
        let objectNamesList = [],
          stageTypeFalg = false,
          checkSetting = true,
          greentplumSettingFalg = true
        if (data && data.stages && data.stages.length) {
          stageTypeFalg = data.stages.every(stage => stage.type === 'database')
          if (stageTypeFalg) {
            data.stages.forEach(item => {
              if (item.syncObjects && item.syncObjects.length) {
                item.syncObjects.forEach(childItem => {
                  if (childItem.objectNames && childItem.objectNames.length) {
                    objectNamesList = childItem.objectNames
                  }
                })
              }
            })
          }
          data.stages.forEach(item => {
            if ((item.type === 'hbase' || item.database_type === 'hbase') && this.sync_type !== 'initial_sync') {
              checkSetting = false
            }
            if (item.type === 'hive' || item.database_type === 'hive') {
              data.setting.transformerConcurrency = 1
              data.setting.readBatchSize = 10000
            }
            if (
              item.outputLanes.length &&
              (item.databaseType === 'greenplum' || item.database_type === 'greenplum') &&
              this.sync_type !== 'initial_sync'
            ) {
              greentplumSettingFalg = false
            }
          })
        }
        // 【增量采集时间】仅增量任务时，选择浏览器时区，时间设置未作必填校验，导致任务启动后不增量同步。
        if (data?.setting?.sync_type === 'cdc') {
          let { syncPoints } = data.setting
          let findOne = syncPoints.find(el => el.type !== 'current' && !el.date)
          if (findOne) {
            this.$message.error(this.$t('task_settings_cdc_sync_point_date'))
            return
          }
        }
        if (!checkSetting) {
          this.$message.error(this.$t('editor.cell.data_node.hbase_check'))
          return
        }
        if (stageTypeFalg && objectNamesList.length === 0) {
          this.$message.error(this.$t('editor.cell.link.chooseATableTip'))
          return
        }
        if (!greentplumSettingFalg) {
          this.$message.error(this.$t('editor.cell.data_node.greentplum_check'))
          return
        }
        if (this.modPipeline) {
          data['modPipeline'] = []
          this.showCheckStagesVisible = false
          data['modPipeline'] = this.modPipeline
        }
        let start = () => {
          data.status = 'scheduled'
          data.executeMode = 'normal'
          this.doSave(data, (err, rest) => {
            if (err) {
              if (err.response.msg === 'Error: Loading data source schema') {
                this.$message.error(this.$t('message.loadingSchema'))
              } else if (err.response.msg === 'DataFlow has add or del stages') {
                if (err.response?.data && err.response?.data?.length > 0) {
                  this.showCheckStagesVisible = true
                  this.checkStagesData = err.response.data
                  this.checkStagesData = this.checkStagesData.filter(v => v.type === 'add') //只展示别删除的
                  for (let i = 0; i < this.checkStagesData.length; i++) {
                    this.checkStagesData[i].syncType = 'initial_sync+cdc'
                  }
                }
              } else if (err.response.msg === 'running transformer') {
                this.showSchemaProgress = true
              } else if (err.response.msg === 'invalid') {
                this.showFieldMappingProgress = true
              } else {
                this.$message.error(err.response.msg)
              }
            } else {
              this.$message.success(this.$t('message.taskStart'))
              this.$router.push({
                name: 'job',
                query: {
                  id: rest.id,
                  isMoniting: true,
                  mapping: this.mappingTemplate
                }
              })
              this.$message.success(this.$t('message.taskStart'))
              location.reload()
            }
          })
        }
        // if (data.id && this.dataFlow.stages.find(s => s.type === 'aggregation_processor')) {
        // 	const h = this.$createElement;
        // 	let arr = this.$t('message.startAggregation_message').split('XXX');
        // 	this.$confirm(
        // 		h('p', [arr[0] + '(', h('span', { style: { color: '#409EFF' } }, data.name), ')' + arr[1]]),
        // 		this.$t('dataFlow.importantReminder'),
        // 		{
        // 			type: 'warning',
        // 			closeOnClickModal: false
        // 		}
        // 	).then(() => {
        // 		//若任务内存在聚合处理器，启动前先重置
        // 		dataFlowsApi.reset(data.id).then(() => {
        // 			start();
        // 		});
        // 	});
        // } else {
        start()
        // }
      }
      this.dialogFormVisible = false
    },
    /*
     * 保存错误信息*/
    saveCheckStages(data) {
      this.showCheckStagesVisible = false
      this.modPipeline = data
      this.start()
    },
    /**
     * stop button handler
     * @param forceStop
     */
    stop(forceStop) {
      let self = this,
        data = {
          id: self.dataFlowId,
          status: forceStop === true ? 'force stopping' : 'stopping'
        }
      let message = self.$t('message.stopMessage')
      if (forceStop === true) {
        message = self.$t('message.forceStoppingMessage')
      }
      if (!self.sync_type.includes('cdc')) {
        message = self.$t('message.stopInitial_syncMessage')
      }
      if (self.dataFlow.stages.find(s => s.type === 'aggregation_processor')) {
        const h = self.$createElement
        let arr = self.$t('message.stopAggregation_message').split('XXX')
        message = h('p', [arr[0] + '(', h('span', { style: { color: '#409EFF' } }, self.dataFlow.name), ')' + arr[1]])
      }
      self
        .$confirm(message, self.$t('dataFlow.importantReminder'), {
          confirmButtonText: forceStop === true ? self.$t('dataFlow.button.force_stop') : self.$t('message.confirm'),
          type: 'warning',
          closeOnClickModal: false
        })
        .then(flag => {
          if (!flag) {
            return
          }
          self.doSave(data, err => {
            if (err) {
              this.$message.error(self.$t('message.stopFail'))
            } else {
              location.reload()
            }
          })
        })

      // .catch(() => {
      // 	this.$message.error(self.$t('message.stopFail'));
      // });
    },

    preview() {
      let self = this,
        data = this.getDataFlowData()
      if (!self.statusBtMap[this.status].start) {
        if (data) {
          if (data.id) {
            data = {
              id: data.id,
              status: ['scheduled', 'running', 'stopping'].includes(data.status) ? data.status : 'scheduled',
              executeMode: 'editing_debug'
            }
          } else {
            Object.assign(data, {
              status: 'scheduled',
              executeMode: 'editing_debug'
            })
          }
          this.isPreview = true
          self.doSave(data, err => {
            if (err) {
              this.$message.error(self.$t('message.saveFail'))
            } else {
              // this.$message.success(self.$t('message.saveOK'));
              this.showCapture()
            }
          })
        }
      }
    },

    /**
     * capture button handler
     */
    capture() {
      let self = this,
        data = this.getDataFlowData()

      if (data) {
        if (data && data.id) {
          data = {
            id: data.id,
            executeMode: 'running_debug'
          }
        } else {
          Object.assign(data, {
            executeMode: 'running_debug'
          })
        }
        self.doSave(data, err => {
          if (err) {
            this.$message.error(self.$t('message.saveFail'))
          } else {
            // this.$message.success(self.$t('message.saveOK'));
            this.showCapture()
          }
        })
      }
    },

    /**
     * stop capture button handler
     */
    stopCapture() {
      let self = this,
        data = this.getDataFlowData()

      if (data && data.id) {
        self.doSave(
          {
            id: data.id,
            executeMode: 'normal'
          },
          err => {
            if (err) {
              this.$message.error(self.$t('message.saveFail'))
            }
          }
        )
      }
    },

    /**
     * reset button handler
     */
    reset() {
      let self = this,
        data = this.getDataFlowData()

      if (data && data.id) {
        self
          .$confirm(self.$t('message.resetMessage'), self.$t('dataFlow.importantReminder'), {
            confirmButtonText: self.$t('dataFlow.button.reset'),
            cancelButtonText: self.$t('message.cancel'),
            closeOnClickModal: false,
            type: 'warning'
          })
          .then(flag => {
            if (!flag) {
              return
            }
            this.loading = true
            dataFlowsApi
              .reset(data.id)
              .then(() => {
                self.$message.success(self.$t('message.resetOk'))
                self.editor.emit('dataFlow:reset')
                location.reload()
              })
              .catch(err => {
                if (err && err.response.status === 500) {
                  self.$message.error(self.$t('message.resetFailed'))
                }
              })
              .finally(() => {
                this.loading = false
              })
          })
      }
    },

    /**
     * show setting button handler
     */
    showSetting() {
      log('Job.showSetting')
      this.editor.showSetting(!this.editable)
      this.editor.graph.selectCell([])
    },
    getGlobalSetting() {
      let where = {
        filter: {
          where: {
            id: '76'
          }
        }
      }
      this.loading = true
      Setting.findOne(where)
        .then(res => {
          if (res.data.value) {
            let value = JSON.parse(res.data.value)
            this.editor.setSettingData(value.runNotification)
          }
        })
        .finally(() => {
          this.loading = false
        })
    },

    /**
     * show logs button handler
     */
    showLogs() {
      this.editor.showLogs(this.dataFlow)
    },

    /**
     * show capture button handler
     */
    showCapture() {
      this.editor.showCapture(this.dataFlow)
    },

    /**
     * reload shcema
     */
    reloadSchema() {
      this.reloadSchemaDialog = true
    },
    /**
     * confirm dialog reload shcema
     */

    confirmReloadSchemaDialog() {
      this.editor.reloadSchema()
      this.reloadSchemaDialog = false
    },

    /**
     * switch edit mode
     * @param editable
     */
    setEditable(editable) {
      log('Job.setEditable', editable, this.dataFlow)
      this.editable = editable
      if (editable && window.getSettingByKey('DFS_CREATE_DATAFLOW_BY_FORM')) {
        this.$router.push({
          name: 'editTask',
          params: {
            id: this.dataFlow.id
          }
        })
        return
      }
      if (editable && this.$route.query.isMoniting) {
        this.$router.push({
          name: 'job',
          query: {
            id: this.dataFlow.id,
            mapping: this.mappingTemplate
          }
        })
        location.reload()
      }
      if (this.dataFlow) {
        delete this.dataFlow.editorData
        this.editor.setEditable(editable, this.dataFlow)
      } else {
        //this.$message.error(this.$t('message.save_before_running'));
      }
    },

    setSelector(type) {
      if (!type) {
        type = 'custom'
      }
      this.editor.setSelector(type)
    },

    /**
     * Reverse editor data
     * @param data
     * @return {{cells: Array}}
     */
    creatApiEditorData(data) {
      // 1. 创建cell 2. 加载schema 3.自动布局
      let cells = []
      let mapping = {
        collection: 'app.Collection',
        table: 'app.Table',
        database: 'app.Database',
        mongodb: 'app.Database',
        mongo_view: 'app.Collection',
        view: 'app.Table',
        'dummy db': 'app.Dummy',
        elasticsearch: 'app.ESNode',
        file: 'app.FileNode',
        gridfs: 'app.GridFSNode',
        'rest api': 'app.ApiNode',
        field_processor: 'app.FieldProcess',
        aggregation_processor: 'app.Aggregate',
        js_processor: 'app.Script',
        row_filter_processor: 'app.DataFilter',
        java_processor: 'app.FieldProcess',
        redis: 'app.Redis',
        hive: 'app.HiveNode',
        hana: 'app.HanaNode',
        dameng: 'app.DamengNode',
        clickhouse: 'app.ClickHouse'
      }
      if (data) {
        let stageMap = {}
        data.forEach(item => {
          stageMap[item.id] = item
        })
        data.map(v => {
          let formData = _.cloneDeep(v)
          delete formData.inputLanes
          delete formData.outputLanes
          if (['table', 'view', 'collection', 'mongo_view', 'hive'].includes(v.type)) {
            let node = {
              type: mapping[v.type],
              id: v.id,
              freeTransform: false,
              form_data: formData,
              schema: null,
              outputSchema: null,
              attrs: {
                label: {
                  text: v.tableName !== '' && v.tableName ? breakText.breakText(v.tableName, 125) : v.type
                }
              },
              angle: 0
            }
            cells.push(node)
          } else if (v.type && ['dummy db', 'gridfs', 'file', 'elasticsearch', 'rest api', 'redis'].includes(v.type)) {
            let node = {
              type: mapping[v.type],
              id: v.id,
              freeTransform: false,
              schema: null,
              outputSchema: null,
              attrs: {
                label: {
                  text: v.name !== '' && v.name ? breakText.breakText(v.name, 125) : v.type
                }
              },
              form_data: formData
            }
            cells.push(node)
          } else if (v.type === 'database') {
            let map = DATABASE_TYPE_MAPPING
            let node = {
              type: mapping[v.type],
              id: v.id,
              freeTransform: false,
              form_data: formData,
              schema: null,
              outputSchema: null,
              attrs: {
                label: {
                  text: v.name !== '' && v.name ? breakText.breakText(v.name, 125) : v.type
                },
                image: {
                  xlinkHref: map[v.database_type].shapeImage
                }
              }
            }
            cells.push(node)
          } else if (
            [
              'field_processor',
              'java_processor',
              'js_processor',
              'aggregation_processor',
              'row_filter_processor'
            ].includes(v.type)
          ) {
            let node = {
              type: mapping[v.type],
              id: v.id,
              freeTransform: false,
              angle: 0,
              schema: null,
              outputSchema: null,
              attrs: {
                label: {
                  text: v.name !== '' && v.name ? breakText.breakText(v.name, 95) : v.type
                }
              }
            }
            if (['field_processor'].includes(v.type)) {
              node.form_data = formData
            } else if (['aggregation_processor'].includes(v.type)) {
              node.form_data = formData
            } else if (['js_processor'].includes(v.type)) {
              node.form_data = formData
            } else if (['row_filter_processor'].includes(v.type)) {
              node.form_data = formData
            }
            cells.push(node)
          }
          if (v.outputLanes) {
            v.outputLanes = v.outputLanes.filter(d => d)
            v.outputLanes.map(k => {
              let type = 'app.Link'
              if (v.type === 'database' && stageMap[k].type === 'database') {
                type = 'app.databaseLink'
              } else {
                type = 'app.Link'
              }

              let node = {
                type: type,
                source: {
                  id: v.id
                },
                target: {
                  id: k
                },
                router: {
                  name: 'manhattan'
                },
                connector: {
                  name: 'rounded'
                },
                form_data: {
                  label: '',
                  joinTable: _.cloneDeep(JOIN_TABLE_TPL)
                },
                labels: '',
                attrs: {}
              }
              cells.push(node)
            })
          }
        })
      }
      this.cells = cells
      return {
        cells: cells
      }
    },
    /**
     * handler join table on after reverse editor data
     * @param stages
     * @param graph
     */
    handleJoinTables(stages, graph) {
      log('Job.handleJoinTables', stages, graph)
      if (stages) {
        stages.map(stage => {
          if (
            stage.joinTables &&
            stage.joinTables.length > 0 &&
            stage.inputLanes &&
            stage.inputLanes.length > 0 &&
            ![
              'field_processor',
              'java_processor',
              'js_processor',
              'aggregation_processor',
              'row_filter_processor'
            ].includes(stage.type)
          ) {
            // 目标节点 数据节点 jointables
            // tableName -> joinTable
            let joinTables = {}
            stage.joinTables.map(table => {
              joinTables[table.stageId] = table
            })

            let cell = graph.getCell(stage.id)
            graph.getConnectedLinks(cell, { inbound: true }).forEach(link => {
              let sourceCell = link.getSourceCell()
              let sourceDataCells = sourceCell.getFirstDataNode().filter(cell => !!joinTables[cell.id])
              if (sourceDataCells && sourceDataCells.length > 0) {
                let formData = link.getFormData()
                formData.joinTable = joinTables[sourceDataCells[0].id]
              }
            })
          }
        })
      }
    },
    querySearch(queryString, cb) {
      let dataCells = this.editor.getAllCells()
      let dataCellName = []
      dataCells.forEach(cell => {
        let formData = typeof cell.getFormData === 'function' ? cell.getFormData() : null
        let tableName = {
          value: formData.tableName || formData.name || '',
          cell: cell
        }
        dataCellName.push(tableName)
      })
      var restaurants = dataCellName
      var results = queryString ? restaurants.filter(this.createFilter(queryString)) : restaurants
      // 调用 callback 返回建议列表的数据
      cb(results)
    },
    createFilter(queryString) {
      return restaurant => {
        return restaurant.value.toLowerCase().indexOf(queryString.toLowerCase()) === 0
      }
    },
    handleSearchNode(item) {
      //选中当前节点
      this.editor.graph.selectionPosition(item.cell)
    }
  },

  beforeDestroy() {
    if (this.timeoutId) {
      clearTimeout(this.timeoutId)
    }
    if (timer) {
      clearTimeout(timer)
      timer = null
    }
    this.editor.destroy()
  }
}
</script>
<style scoped lang="scss">
.spinner-box {
  display: inline-block;
  padding: 0 5px;
  vertical-align: middle;
  .spinner {
    align-items: center;
    background: #fff;
    border-radius: 50%;
    display: flex;
    height: 15px;
    justify-content: center;
    // margin: 1em 1em 2em 1em;
    width: 15px;
  }
  .canvas_gif {
    animation: spinner 2s linear infinite;
    // border: 1px solid transparent;

    border-radius: 100%;
    align-items: center;
    height: 1em;
    width: 1em;
  }
  .scheduled_gif {
    border: 0.1em solid transparent;
    border-top: 0.1em solid #67c23a;
    border-right: 0.1em solid #67c23a;
  }

  .stopping_gif {
    border-top: 0.1em solid rgb(241, 145, 73);
    border-right: 0.1em solid rgb(241, 145, 73);
  }
}

@keyframes spinner {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}
</style>
<style lang="scss">
//@import url(../../editor/style/editor.scss);
@import '../../editor/style/editor';
.editor-container {
  .flex-center {
    display: flex;
    align-items: center;
  }
  .backIcon {
    position: absolute;
    left: 0;
    top: 0;
    width: 41px;
    height: 41px;
    line-height: 41px;
    font-size: 19px;
    text-align: center;
    color: #fff;
    cursor: pointer;
    background-color: #409eff;
  }
  .backIcon:hover {
    background-color: #6dc5e8;
  }
  .icon-margin-right-5 {
    margin-right: 5px !important;
  }
  .action-btn-group {
    display: flex;
  }
  .action-btn,
  .btn-setting {
    border: none;
    background: #eee;
    color: #606266;
    &.is-disabled,
    &.btn-operatiton.is-disabled {
      background: #eee;
      color: #bbb;
      &:hover {
        color: #bbb;
        background: #eee;
      }
    }
    &:hover,
    &:focus {
      color: #606266;
      background: rgba(225, 225, 225, 1);
    }
  }
  .btn-operatiton {
    padding: 0 10px;
    background: rgba(225, 225, 225, 1);
  }
  .action-btn {
    margin-right: 10px;
    padding: 0 6px;
    line-height: 26px;
    height: 26px;
    border-left: 1px solid #ddd;
    z-index: 1;
    &.btn-operatiton {
      padding: 0 10px 0 6px;
      background: rgba(225, 225, 225, 1);
      &:hover {
        background: #cfcfcf;
      }
    }
    &:first-child {
      border: none;
    }
    .iconfont {
      font-size: 12px;
    }
  }
  .btn-setting {
    padding: 0;
    &:hover {
      .iconfont {
        color: #606266;
        background: #e1e1e1;
      }
    }
    .iconfont {
      display: inline-block;
      text-align: center;
      font-size: 12px;
      line-height: 26px;
      height: 26px;
      width: 26px;
      color: #606266;
      background: rgba(225, 225, 225, 1);
    }
    .btn-setting-text {
      display: inline-block;
      padding: 0 6px;
    }
  }
  .btn-edit {
    padding: 6px 10px;
    .iconfont {
      font-size: 12px;
    }
  }
}

.systemHint {
  .el-dialog__body {
    overflow: hidden;
    padding: 20px !important;
    box-sizing: border-box;
    .el-form {
      overflow: hidden;
      .text {
        display: inline-block;
        padding-bottom: 30px;
      }
      .content {
        max-height: 260px;
        overflow: auto;
        .el-row {
          padding-bottom: 5px;
          .el-button--text {
            color: #666;
          }
          .el-button--text:hover {
            color: #409eff;
          }
          .delStyle:hover {
            color: #f56c6c;
          }
        }
      }
    }
  }
  .delet.el-button--text {
    color: #f56c6c;
  }
  .delet.el-button--text:hover {
    color: #f00;
  }
}
.dialogConfig {
  .el-dialog__header {
    background: rgba(250, 250, 250, 1);
    border: 1px solid rgba(222, 222, 228, 1);
  }
  .el-dialog__body {
    padding-bottom: 0;
  }
  .e-input,
  .el-select {
    width: calc(100% - 120px);
    height: 30px;
    line-height: 30px;
    input {
      height: 30px;
      line-height: 30px;
    }
  }
  .el-form-item__content {
    line-height: 30px;
  }
  .el-form--label-left .el-form-item__label {
    width: 120px;
    line-height: 30px;
    font-size: 13px;
  }
  .el-button {
    padding: 8px 20px;
  }
}
.searchNode {
  .el-input {
    display: block;
  }
  .el-input__inner {
    height: 26px;
    background: #eee;
    color: rgba(170, 170, 170, 1);
  }
  .el-input--mini .el-input__icon {
    line-height: 26px;
  }
  margin-right: 8px;
}
// .el-tooltip__popper.is-dark {
// 	background-color: #d3d3d3 !important;
// 	color: #333 !important;
// 	font-size: 16px;
// }
// 控制主题颜色

// .el-tooltip__popper[x-placement^='bottom'] .popper__arrow::after {
// 	border-bottom-color: #d3d3d3 !important;
// }

// .el-tooltip__popper[x-placement^='bottom'] .popper__arrow {
// 	border-bottom-color: #d3d3d3 !important;
// }
</style>
