<template>
  <Drawer v-loading="loading" class="overflow-hidden" style="width: 838px" :visible.sync="visible">
    <div class="flex flex-column overflow-hidden pt-2 h-100">
      <!-- 顶部 标题 Tab -->
      <div class="flex position-relative">
        <div class="position-absolute top-0 start-0 fs-7 fw-sub px-6 font-color-dark" style="line-height: 36px">
          {{ data.id ? $t('daas_data_server_drawer_fuwuxiangqing') : $t('daas_data_server_drawer_chuangjianfuwu') }}
        </div>
        <ElTabs v-model="tab" class="data-server__tabs flex-1" @tab-click="tabChanged">
          <ElTabPane :label="$t('daas_data_server_drawer_peizhi')" name="form"></ElTabPane>
          <ElTabPane
            v-if="data.status === 'active'"
            :label="$t('daas_data_server_drawer_tiaoshi')"
            name="debug"
          ></ElTabPane>
        </ElTabs>
      </div>
      <ElForm
        hide-required-asterisk
        class="data-server__form p-6 overflow-auto flex-1 pb-16"
        ref="form"
        label-position="left"
        size="mini"
        :model="form"
        :rules="rules"
      >
        <!-- 服务{{$t('metadata_name')}} -->
        <div class="flex justify-content-between align-items-start">
          <ElFormItem prop="name" class="flex-1" size="small">
            <ElInput v-if="isEdit" v-model="form.name"></ElInput>
            <div v-else class="fw-sub fs-7 font-color-normal">{{ data.name }}</div>
          </ElFormItem>
          <template v-if="tab === 'form' && data.status !== 'active'">
            <div v-if="isEdit" class="ml-10">
              <ElButton v-if="data.id" class="mr-4" size="mini" @click="isEdit = false">{{
                $t('button_cancel')
              }}</ElButton>
              <ElButton type="primary" size="mini" @click="save">{{ $t('button_save') }}</ElButton>
            </div>
            <ElButton v-else class="ml-10" type="primary" size="mini" @click="edit">{{ $t('button_edit') }}</ElButton>
          </template>
        </div>
        <ElFormItem prop="description" class="flex-1 mt-4" size="small">
          <ElInput
            v-model="form.description"
            type="textarea"
            :placeholder="$t('function_describe_placeholder')"
            :disabled="!isEdit"
          ></ElInput>
        </ElFormItem>
        <ElFormItem prop="acl" class="flex-1 mt-4" size="small" label="权限范围" required>
          <ElSelect v-model="form.acl" multiple :disabled="!isEdit">
            <ElOption v-for="item in roles" :label="item.name" :value="item.name" :key="item.id"></ElOption>
          </ElSelect>
        </ElFormItem>

        <!-- 基础信息 -->
        <ul v-if="tab === 'form'" class="flex flex-wrap bg-main p-2 mt-4 rounded-1">
          <li class="data-server-form-base__item">
            <ElFormItem :label="$t('daas_data_server_drawer_caozuoleixing')" label-width="66px">
              <div class="text">{{ $t('dataExplorer_query') }}</div>
            </ElFormItem>
          </li>
          <li class="data-server-form-base__item">
            <ElFormItem :label="$t('daas_data_server_drawer_fabujiedian')" label-width="66px">
              <div class="text">{{ $t('select_option_all') }}</div>
            </ElFormItem>
          </li>
          <li class="data-server-form-base__item">
            <ElFormItem :label="$t('daas_data_server_drawer_jiekouleixing')" label-width="66px">
              <ElSelect v-if="isEdit" v-model="form.apiType" @change="apiTypeChanged">
                <ElOption v-for="(label, value) in apiTypeMap" :key="value" :value="value" :label="label"></ElOption>
              </ElSelect>
              <div v-else class="text">{{ apiTypeMap[data.apiType] }}</div>
            </ElFormItem>
          </li>
          <li class="data-server-form-base__item">
            <ElFormItem :label="$t('connection_list_type')" label-width="66px" prop="connectionType">
              <ElSelect
                v-if="isEdit"
                v-model="form.connectionType"
                filterable
                :loading="!databaseTypes"
                @change="connectionTypeChanged"
              >
                <ElOption v-for="item in databaseTypes" :key="item" :value="item" :label="item"></ElOption>
              </ElSelect>
              <div v-else class="text">{{ data.connectionType }}</div>
            </ElFormItem>
          </li>
          <li class="data-server-form-base__item">
            <ElFormItem :label="$t('daas_data_server_drawer_lianjiemingcheng')" label-width="66px" prop="connectionId">
              <ElSelect
                v-if="isEdit"
                v-model="form.connectionName"
                filterable
                :loading="!connectionOptions"
                @change="connectionNameChanged"
              >
                <ElOption
                  v-for="item in connectionOptions"
                  :key="item.name"
                  :value="item.name"
                  :label="item.name"
                ></ElOption>
              </ElSelect>
              <div v-else class="text">{{ data.connectionName }}</div>
            </ElFormItem>
          </li>
          <li class="data-server-form-base__item">
            <ElFormItem :label="$t('object_list_name')" label-width="66px" prop="tableName">
              <ElSelect
                v-if="isEdit"
                v-model="form.tableName"
                filterable
                :loading="!tableOptions"
                @change="tableChanged"
              >
                <ElOption v-for="item in tableOptions" :key="item" :value="item" :label="item"></ElOption>
              </ElSelect>
              <div v-else class="text">{{ data.tableName }}</div>
            </ElFormItem>
          </li>
        </ul>

        <!-- 輸入参数 -->
        <div class="data-server-panel__title">
          <div>
            <span>{{ $t('daas_data_server_drawer_shurucanshu') }}</span>
            <i
              v-if="isEdit && form.apiType === 'customerQuery'"
              class="el-icon-circle-plus icon-button color-primary ml-4"
              @click="addItem('params')"
            ></i>
          </div>
        </div>
        <ElTable class="flex-1" :data="isEdit ? form.params : data.params">
          <ElTableColumn :label="$t('daas_data_server_drawer_canshumingcheng')" prop="name" min-width="120">
            <template #default="{ row, $index }">
              <div v-if="isEdit && $index > 1 && form.apiType === 'customerQuery'">
                <ElFormItem
                  :prop="`params.${$index}.name`"
                  :error="!form.params[$index].name ? 'true' : ''"
                  :show-message="false"
                  :rules="rules.param"
                >
                  <ElInput v-model="form.params[$index].name" size="mini"></ElInput>
                </ElFormItem>
              </div>
              <div v-else>{{ row.name }}</div>
            </template>
          </ElTableColumn>
          <ElTableColumn :label="$t('metadata_type')" prop="type">
            <template #default="{ row, $index }">
              <div v-if="isEdit && $index > 1 && form.apiType === 'customerQuery'" min-width="60">
                <ElSelect v-model="form.params[$index].type" size="mini">
                  <ElOption v-for="type in typeOptions" :key="type" :value="type" :label="type"></ElOption>
                </ElSelect>
              </div>
              <div v-else>{{ row.type }}</div>
            </template>
          </ElTableColumn>
          <ElTableColumn
            v-if="tab === 'form'"
            :label="$t('meta_table_default')"
            prop="defaultvalue"
            key="defaultvalue"
            min-width="60"
          >
            <template #default="{ row, $index }">
              <div v-if="isEdit && row.defaultvalue !== undefined">
                <ElInput v-model="form.params[$index].defaultvalue" size="mini"></ElInput>
              </div>
              <div v-else>{{ row.defaultvalue }}</div>
            </template>
          </ElTableColumn>
          <ElTableColumn :label="$t('module_form_describtion')" prop="description" min-width="100">
            <template #default="{ row, $index }">
              <div v-if="isEdit && $index > 1 && form.apiType === 'customerQuery'">
                <ElInput v-model="form.params[$index].description" size="mini"></ElInput>
              </div>
              <div v-else>{{ row.description }}</div>
            </template>
          </ElTableColumn>
          <ElTableColumn
            v-if="debugParams"
            :label="$t('daas_data_server_drawer_canshuzhi')"
            key="value"
            min-width="100"
          >
            <template #default="{ row }">
              <ElInput v-model="debugParams[row.name]" size="mini"></ElInput>
            </template>
          </ElTableColumn>
          <ElTableColumn v-if="isEdit && form.apiType === 'customerQuery'" align="center" width="60">
            <template #default="{ $index }">
              <i v-if="$index > 1" class="el-icon-remove icon-button" @click="removeItem('params', $index)"></i>
            </template>
          </ElTableColumn>
        </ElTable>

        <template v-if="data.apiType === 'customerQuery' || form.apiType === 'customerQuery'">
          <!-- 筛选条件 -->
          <div class="data-server-panel__title">
            <div>
              <span>{{ $t('daas_data_server_drawer_shaixuantiaojian') }}</span>
              <i v-if="isEdit" class="el-icon-circle-plus icon-button color-primary ml-4" @click="addItem('where')"></i>
            </div>
          </div>
          <ul v-if="isEdit">
            <li v-for="(item, index) in form.where" class="flex align-items-center" :key="index">
              <ElSelect v-model="form.where[index].fieldName" class="mr-4">
                <ElOption
                  v-for="opt in allFields"
                  :key="opt.id"
                  :value="opt.field_name"
                  :label="opt.field_name"
                ></ElOption>
              </ElSelect>
              <ElSelect v-model="form.where[index].operator" size="mini" class="mr-4">
                <ElOption v-for="item in operatorOptions" :key="item" :value="item" :label="item"></ElOption>
              </ElSelect>
              <ElSelect v-model="form.where[index].parameter" class="mr-4">
                <ElOption
                  v-for="opt in parameterOptions"
                  :key="opt.name"
                  :value="opt.name"
                  :label="opt.name"
                ></ElOption>
              </ElSelect>
              <ElSelect v-model="form.where[index].condition" size="mini" class="mr-4">
                <template v-for="item in conditionOptions">
                  <ElOption
                    v-if="item !== 'null' || index === form.where.length - 1"
                    :key="item"
                    :value="item"
                    :label="item"
                  ></ElOption>
                </template>
              </ElSelect>
              <i class="el-icon-remove icon-button" @click="removeItem('where', index)"></i>
            </li>
          </ul>
          <ul v-else>
            <li v-for="(item, index) in data.where" class="flex align-items-center" :key="index">
              <span class="mr-4">{{ item.fieldName }}</span>
              <span class="mr-4">{{ item.operator }}</span>
              <span class="mr-4">{{ item.parameter }}</span>
              <span>{{ item.condition }}</span>
            </li>
          </ul>

          <!-- 排列条件 -->
          <div class="data-server-panel__title">
            <div>
              <span>{{ $t('daas_data_server_drawer_pailietiaojian') }}</span>
              <i v-if="isEdit" class="el-icon-circle-plus icon-button color-primary ml-4" @click="addItem('sort')"></i>
            </div>
          </div>
          <ul v-if="isEdit">
            <li v-for="(item, index) in form.sort" class="flex align-items-center" :key="index">
              <ElSelect v-model="form.sort[index].fieldName" class="mr-4">
                <ElOption
                  v-for="opt in allFields"
                  :key="opt.id"
                  :value="opt.field_name"
                  :label="opt.field_name"
                ></ElOption>
              </ElSelect>
              <ElSelect v-model="form.sort[index].type" size="mini" class="mr-4">
                <ElOption value="asc" label="ASC"></ElOption>
                <ElOption value="desc" label="DESC"></ElOption>
              </ElSelect>
              <i class="el-icon-remove icon-button" @click="removeItem('sort', index)"></i>
            </li>
          </ul>
          <ul v-else>
            <li v-for="(item, index) in data.sort" class="flex align-items-center" :key="index">
              <span class="mr-4">{{ item.fieldName }}</span>
              <span>{{ item.type }}</span>
            </li>
          </ul>
        </template>

        <!-- 输出结果 -->
        <template v-if="tab === 'form'">
          <div class="data-server-panel__title">{{ $t('daas_data_server_drawer_shuchujieguo') }}</div>
          <ElTable
            ref="fieldTable"
            :data="isEdit ? allFields : data.fields"
            :loading="fieldLoading"
            @selection-change="fieldsChanged"
          >
            <ElTableColumn v-if="isEdit" type="selection" width="55"></ElTableColumn>
            <ElTableColumn :label="$t('metadata_name')" prop="field_name" min-width="200"></ElTableColumn>
            <ElTableColumn :label="$t('metadata_type')" prop="originalDataType" min-width="120"></ElTableColumn>
            <ElTableColumn :label="$t('module_form_describtion')" prop="comment" min-width="50"></ElTableColumn>
          </ElTable>
        </template>
        <template v-if="tab === 'form' && !isEdit">
          <div class="data-server-panel__title">
            <span>{{ $t('daas_data_server_drawer_fuwufangwen') }}</span>
            <ElButton v-if="data.status === 'generating'" type="primary" size="mini" @click="generate">{{
              $t('application_generator')
            }}</ElButton>
          </div>
          <ul v-if="data.path" class="data-server-path">
            <li v-for="(url, method) in urls" :key="method" class="data-server-path__item">
              <div class="data-server-path__method" :class="'method--' + method">
                {{ method }}
              </div>
              <div class="data-server-path__value line-height">{{ url }}</div>
            </li>
          </ul>
        </template>

        <!-- {{$t('daas_data_server_drawer_diaoyongfangshi')}} -->
        <template v-if="tab === 'debug'">
          <div class="data-server-panel__title">{{ $t('daas_data_server_drawer_diaoyongfangshi') }}</div>
          <div class="flex">
            <div class="data-server-debug__url flex-1 flex align-center mr-4">
              <ElSelect v-model="debugMethod" class="data-server-debug__method mr-4" style="width: 100px" size="mini">
                <ElOption v-for="(url, method) in urls" :key="method" :value="method"></ElOption>
              </ElSelect>
              <div>{{ urls[debugMethod] }}</div>
            </div>
            <ElButton type="primary" size="mini" @click="debugData">{{ $t('button_submit') }}</ElButton>
          </div>
        </template>
        <template v-if="tab === 'debug'">
          <div class="data-server-panel__title">{{ $t('daas_data_server_drawer_fanhuijieguo') }}</div>
          <VCodeEditor
            height="280"
            lang="json"
            :options="{ printMargin: false, readOnly: true, wrap: 'free' }"
            :value="debugResult"
          ></VCodeEditor>
        </template>

        <!--  {{$t('daas_data_server_drawer_shilidaima2')}} -->
        <template v-if="tab === 'debug'">
          <div class="flex position-relative mt-8 mb-4">
            <div class="position-absolute top-0 start-0 fs-7 fw-sub font-color-dark" style="line-height: 36px">
              {{ $t('daas_data_server_drawer_shilidaima') }}
            </div>
            <ElTabs v-model="templateType" class="data-server__tabs flex-1">
              <ElTabPane label="JAVA" name="java"></ElTabPane>
              <ElTabPane label="JS" name="javascript"></ElTabPane>
              <ElTabPane label="PYTHON" name="python"></ElTabPane>
            </ElTabs>
          </div>
          <VCodeEditor
            height="280"
            :lang="templateType"
            :options="{ printMargin: false, readOnly: true, wrap: 'free' }"
            :value="templates[templateType]"
          ></VCodeEditor>
        </template>
      </ElForm>
    </div>
  </Drawer>
</template>

<script>
import i18n from '@/i18n'

import axios from 'axios'
import { cloneDeep } from 'lodash'

import { databaseTypesApi, connectionsApi, metadataInstancesApi, modulesApi, applicationApi, roleApi } from '@tap/api'
import { Drawer, VCodeEditor } from '@tap/component'
import { uid } from '@tap/shared'

import getTemplate from './template'

export default {
  components: { Drawer, VCodeEditor },
  props: {
    host: String
  },
  data() {
    const validateParams = (rule, value, callback) => {
      // eslint-disable-next-line no-control-regex
      if (/^([^\x00-\xff]|[a-zA-Z_$])([^\x00-\xff]|[a-zA-Z0-9_$])*$/.test(value)) {
        callback()
      } else {
        callback(i18n.t('daas_data_server_drawer_geshicuowu'))
      }
    }
    return {
      loading: false,
      visible: false,
      data: {},
      form: {},
      tab: 'form',
      isEdit: false,
      rules: {
        name: [{ required: true, message: i18n.t('daas_data_server_drawer_qingshurufuwu'), trigger: 'blur' }],
        connectionType: [
          { required: true, message: i18n.t('daas_data_server_drawer_qingxuanzelianjie'), trigger: 'blur' }
        ],
        connectionId: [{ required: true, message: i18n.t('shared_cache_placeholder_connection'), trigger: 'blur' }],
        tableName: [{ required: true, message: i18n.t('daas_data_server_drawer_qingxuanzeduixiang'), trigger: 'blur' }],
        param: [{ required: true, validator: validateParams, trigger: ['blur', 'change'] }]
      },
      apiTypeMap: {
        defaultApi: i18n.t('daas_data_server_drawer_morenchaxun'),
        customerQuery: i18n.t('daas_data_server_drawer_zidingyichaxun')
      },
      databaseTypes: null,
      connectionOptions: null,
      tableOptions: [],
      typeOptions: ['number', 'string', 'boolean', 'date', 'datetime', 'time'],
      operatorOptions: ['>', '==', '<', '>=', '<=', '!=', 'like'],
      conditionOptions: ['null', 'and', 'or'],
      allFields: [],
      fieldLoading: false,

      debugParams: null,
      debugMethod: 'GET',
      debugResult: '',

      urls: [],

      templates: {},
      templateType: 'java',

      token: '',
      roles: []
    }
  },
  computed: {
    parameterOptions() {
      return this.form?.params?.filter(item => !['page', 'limit'].includes(item.name)) || []
    }
  },
  mounted() {
    this.getRoles()
  },
  methods: {
    // 打开并初始化抽屉
    open(formData) {
      this.tab = 'form'
      this.visible = true
      this.isEdit = false
      this.debugParams = null
      this.debugMethod = 'GET'
      this.debugResult = ''
      this.allFields = []

      this.$refs?.form?.clearValidate()
      this.formatData(formData || {})
      if (!this.data.id) {
        this.edit()
      }
    },
    tabChanged() {
      this.isEdit = false
      let debugParams = null
      if (this.tab === 'debug') {
        debugParams = {}
        this.data.params.forEach(p => {
          debugParams[p.name] = p.defaultvalue || ''
        })
      }
      this.debugParams = debugParams
    },
    formatData(formData = {}) {
      // 兼容老数据类型
      if (formData.apiType === 'customerApi') {
        formData.apiType = 'customerQuery'
      }
      const path = formData?.paths?.[0] || {}
      const { id, name, description, status, connectionType, connectionName, connectionId, tableName, basePath } =
        formData
      // 若为新建时，则默认值为 ‘默认查询(defaultApi)’ 的值
      let apiType = formData?.apiType || 'defaultApi'
      this.data = {
        status: status || 'generating', // generating,pending,active
        id,
        name,
        description,
        apiType: apiType,
        connectionType,
        connectionName,
        connectionId,
        tableName,
        basePath,

        method: path.method || 'GET',
        fields: path.fields || [],
        params: path.params || this.getDefaultParams(apiType),
        where: path.where || [],
        sort: path.sort || [],
        path: path.path || ''
      }
      this.form.description = this.data.description
      this.form.acl = path.acl
      let host = this.host
      let _path = this.data.path
      let baseUrl = host + _path
      this.urls = {
        POST: `${baseUrl}/find`,
        GET: `${baseUrl}`,
        TOKEN: `${location.origin + location.pathname}oauth/token`
      }
      if (this.data.status === 'active') {
        this.getAPIServerToken(token => {
          this.templates = getTemplate(baseUrl, token)
        })
      }
    },
    // 获取角色
    getRoles() {
      roleApi.get({}).then(data => {
        this.roles = data?.items || []
      })
    },
    getDefaultParams(apiType) {
      let params = [
        {
          name: 'page',
          type: 'number',
          defaultvalue: '1',
          description: i18n.t('daas_data_server_drawer_fenyebianhao'),
          required: true
        },
        {
          name: 'limit',
          type: 'number',
          defaultvalue: '20',
          description: i18n.t('daas_data_server_drawer_meigefenyefan'),
          required: true
        }
      ]
      if (apiType === 'defaultApi') {
        params.push(
          ...[
            { name: 'sort', type: 'object', description: i18n.t('daas_data_server_drawer_paixu') },
            { name: 'filter', type: 'object', description: i18n.t('module_form_condition') }
          ]
        )
      }
      return params
    },
    // 切换到编辑状态
    edit() {
      this.isEdit = true
      this.form = cloneDeep(this.data)
      this.form.status = 'generating'
      this.form.path = ''
      this.form.basePath = ''
      this.getDatabaseTypes()
      let { connectionId, tableName } = this.form
      if (connectionId) {
        this.getTableOptions(connectionId)
      }
      if (connectionId && tableName) {
        this.getFields()
      }
    },
    // 保存，新建和修改
    save() {
      this.$refs.form.validate(async valid => {
        if (valid) {
          let {
            id,
            name,
            description,
            apiType,
            basePath,
            connectionId,
            tableName,
            params,
            where,
            sort,
            fields,
            method,
            path,
            status,
            acl,
            connectionType,
            connectionName
          } = this.form
          if (params.some(it => !it.name.trim())) {
            return this.$message.error(i18n.t('daas_data_server_drawer_qingshurucanshu'))
          }
          this.loading = true
          const data = await modulesApi[id ? 'patch' : 'post']({
            id,
            status,
            name,
            description,
            apiType,
            connectionId,
            connectionName,
            connectionType,
            operationType: method,
            tableName,
            basePath,
            readConcern: '',
            readPreference: '',
            readPreferenceTag: '',

            datasource: connectionId, // 冗余老字段
            tablename: tableName, // 冗余老字段
            apiVersion: '', // 冗余老字段
            prefix: '', // 冗余老字段
            listtags: [], // 冗余老字段

            paths: [
              {
                name: apiType === 'customerQuery' ? 'customerQuery' : 'findPage', // 冗余老字段
                result: 'Page<Document>', // 冗余老字段
                type: apiType === 'customerQuery' ? 'customerQuery' : 'preset', // 冗余老字段
                acl: acl, // 冗余老字段

                method,
                params,
                where,
                sort,
                fields,
                path
              }
            ],

            fields: this.allFields
          }).finally(() => {
            this.loading = false
          })
          data.connection = connectionId
          data.source = {
            database_type: connectionType,
            name: connectionName
          }
          this.formatData(data || [])
          this.$emit('save')
          this.isEdit = false
        }
      })
    },
    generate() {
      this.form = cloneDeep(this.data)
      let basePath = uid()
      this.form.basePath = basePath
      this.form.path = `/api/${basePath}`
      this.form.status = 'pending'
      this.$nextTick(() => {
        // save会校验表单项，不加nextTick会导致验证不通过
        this.save()
      })
    },
    // 获取可选数据源类型
    async getDatabaseTypes() {
      this.databaseTypes = null
      const data = await databaseTypesApi.get().catch(() => {
        this.databaseTypes = []
      })
      this.databaseTypes =
        data
          ?.filter(it => ['mysql', 'sqlserver', 'oracle', 'mongodb', 'pg', 'tidb'].includes(it.pdkId))
          ?.map(it => it.name) || []
      // this.databaseTypes = data?.map(it => it.name) || []
      this.getConnectionOptions()
    },
    // 获取可选连接
    async getConnectionOptions() {
      let filter = {
        fields: { id: true, name: true, connection_type: true, status: true, user_id: true, database_type: true },
        where: {
          database_type: this.form.connectionType
            ? this.form.connectionType
            : {
                in: this.databaseTypes
              },
          connection_type: {
            in: ['source_and_target', 'target']
          }
        }
      }
      let type = this.form.connectionType
      if (type) {
        filter.where.database_type = type
      }
      this.connectionOptions = null
      const data = await connectionsApi.listAll(filter).catch(() => {
        this.connectionOptions = []
      })
      this.connectionOptions = data?.map(it => ({ name: it.name, type: it.database_type, id: it.id })) || []
    },
    // 获取可选表，依赖连接id
    async getTableOptions(id) {
      this.tableOptions = null
      const data = await metadataInstancesApi.getTables(id).catch(() => {
        this.tableOptions = []
      })
      this.tableOptions = data || []
    },
    // 获取输出结果中可配置的所有字段
    async getFields() {
      this.fieldLoading = true
      let filter = {
        where: { 'source.id': this.form.connectionId, original_name: this.form.tableName, is_deleted: false }
      }
      const data = await metadataInstancesApi
        .get({
          filter: JSON.stringify(filter)
        })
        .finally(() => {
          this.fieldLoading = false
        })
      this.allFields =
        data?.items?.[0]?.fields?.map(it => {
          return Object.assign({}, it, {
            id: it.id,
            field_name: it.field_name,
            originalDataType: it.data_type,
            comment: ''
          })
        }) || []
      if (!this.form.id) {
        this.form.fields = cloneDeep(this.allFields)
      }
      // 回显输出结果中被选中的字段
      const fields = this.form.fields || []
      this.$nextTick(() => {
        fields.forEach(row => {
          this.$refs?.fieldTable.toggleRowSelection(this.allFields.find(it => it.id === row.id))
        })
      })
    },
    apiTypeChanged() {
      this.form.params = this.getDefaultParams(this.form.apiType)
    },
    connectionTypeChanged() {
      this.getConnectionOptions()
      this.form.connectionName = ''
      this.form.tableName = ''
      this.form.fields = []
      this.allFields = []
      this.$refs?.form?.clearValidate('connectionType')
    },
    connectionNameChanged() {
      // 选择连接名时自动填充连接类型
      const connection = this.connectionOptions.find(it => it.name === this.form.connectionName)
      this.form.connectionType = connection.type
      this.form.connectionId = connection.id
      this.form.tableName = ''
      this.form.fields = []
      this.allFields = []
      this.getTableOptions(connection.id)
      this.$refs?.form?.clearValidate('connectionId')
    },
    tableChanged() {
      this.form.fields = []
      this.allFields = []
      this.getFields()
      this.$refs?.form?.clearValidate('tableName')
    },
    fieldsChanged(val) {
      this.form.fields = val
    },
    addItem(key) {
      let map = {
        params: { name: '', type: 'string', description: '', defaultvalue: '' },
        where: { fieldName: '', parameter: '', operator: '>', condition: 'and' },
        sort: { fieldName: '', type: 'asc' }
      }
      if (key === 'where') {
        let list = this.form.where
        let lastItem = list[list.length - 1]
        if (list.length && lastItem.condition === 'null') {
          lastItem.condition = 'and'
        }
      }
      this.form[key].push(cloneDeep(map[key]))
    },
    removeItem(key, index) {
      this.form[key].splice(index, 1)
    },
    async getAPIServerToken(callback) {
      const clientInfo = await applicationApi.get({
        filter: JSON.stringify({
          where: {
            clientName: 'Data Explorer'
          }
        })
      })
      const clientInfoItem = clientInfo?.items?.[0] || {}

      const paramsStr =
        'grant_type=client_credentials&client_id=' + clientInfoItem.id + '&client_secret=' + clientInfoItem.clientSecret
      const result = await axios.create().post('/oauth/token', paramsStr)
      const token = result?.data?.access_token || ''
      this.token = token
      callback && callback(token)
    },
    async debugData() {
      let http = axios.create()
      let params = this.debugParams
      let method = this.debugMethod
      if (method === 'TOKEN') {
        this.debugResult = JSON.stringify(
          {
            access_token: this.token,
            expires_in: 1209599,
            scope: 'admin',
            token_type: 'Bearer'
          },
          null,
          2
        )
      } else {
        let url = this.urls[this.debugMethod] + '?access_token=' + this.token
        for (const key in params) {
          const value = params[key]
          if (!value) {
            delete params[key]
          }
        }
        if (method === 'GET') {
          params = {
            params: params
          }
        }
        let result = await http[method.toLowerCase()](url, params).catch(error => {
          let result = error?.response?.data
          result = result ? JSON.stringify(result, null, 2) : ''
          this.debugResult = result
        })
        if (result) {
          this.debugResult = JSON.stringify(result?.data, null, 2)
        }
      }
    }
  }
}
</script>
<style lang="scss" scoped>
.icon-button {
  font-size: 15px;
  cursor: pointer;
}
.el-icon-remove {
  color: map-get($iconFillColor, normal);
}
.line-height {
  line-height: 22px;
}
.data-server__tabs {
  ::v-deep {
    .el-tabs__nav-wrap.is-top {
      padding-left: 112px;
    }
    .el-tabs__header.is-top {
      margin: 0;
    }
  }
}
.data-server__form {
  ::v-deep {
    .el-form-item {
      margin-bottom: 0;
    }
    .el-form-item__label {
      line-height: 30px;
    }
  }
}
.data-server-form-base__item {
  padding: 4px 8px;
  width: 30%;
  .text {
    font-size: 12px;
    word-break: break-word;
  }
}
.data-server-panel__title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 32px;
  margin-bottom: 16px;
  height: 22px;
  line-height: 22px;
  font-weight: 500;
  font-size: 14px;
  color: map-get($fontColor, dark);
  user-select: none;
}
.data-server-path__item {
  display: flex;
  align-items: center;
  padding: 8px 0;
  font-family: PingFangSC-Regular, PingFang SC;
}
.data-server-path__method {
  margin-right: 40px;
  width: 62px;
  height: 22px;
  line-height: 22px;
  text-align: center;
  border-radius: 2px;

  color: map-get($fontColor, white);
  &.method--POST {
    background: #478c6c;
  }
  &.method--GET {
    background: #09819c;
  }
  &.method--TOKEN {
    background: #f2994b;
  }
}
.data-server-debug__url {
  border: 1px solid map-get($borderColor, form);
  background: map-get($bgColor, form);
  border-radius: 4px;
  font-family: PingFangSC-Regular, PingFang SC;
}
.data-server-debug__method {
  ::v-deep {
    .el-input__inner {
      border: none;
      background: transparent;
    }
  }
}
</style>
