<template>
  <section class="modules-list-wrap">
    <TablePage
      ref="table"
      row-key="id"
      class="modules-list"
      :classify="{
        authority: 'API_category_management',
        types: ['api'],
      }"
      :remoteMethod="getData"
      @selection-change="handleSelectionChange"
      @classify-submit="handleOperationClassify"
      @sort-change="handleSortTable"
    >
      <template v-slot:search>
        <div class="search-bar">
          <div class="search-status pr-4">
            {{ $t('modules_api_server_status') }}:
            <span class="status-text" :class="status">{{ getStatus(status) }}</span>
          </div>
          <FilterBar v-model:value="searchParams" :items="filterItems" @fetch="table.fetch(1)"> </FilterBar>
        </div>
      </template>
      <template v-slot:operation>
        <div>
          <ElButton v-if="selectedStopped.length" @click="batch('active')">{{ $t('modules_allarelease') }}</ElButton>

          <ElButton v-if="selectedRunning.length" @click="batch('pending')">{{ $t('modules_allacancel') }}</ElButton>
          <ElButton @click="exportFile">{{ $t('public_button_export') }}</ElButton>
          <ElButton @click="importFile">{{ $t('modules_import') }}</ElButton>
          <ElButton
            v-show="multipleSelection.length > 0"
            v-readonlybtn="'data_catalog_category_application'"
            class="btn"
            @click="$refs.table.showClassify(handleSelectTag())"
          >
            <i class="iconfont icon-biaoqian back-btn-icon"></i>
            <span> {{ $t('public_button_bulk_tag') }}</span>
          </ElButton>
          <ElButton v-readonlybtn="'API_creation'" class="btn btn-create" type="primary" @click="openCreateDialog">
            <!-- <i class="iconfont icon-jia add-btn-icon"></i> -->
            <span>{{ $t('modules_create') }}</span>
          </ElButton>
        </div>
      </template>
      <el-table-column type="selection" width="45" :reserve-selection="true"></el-table-column>
      <el-table-column :label="$t('modules_header_api_name')" show-overflow-tooltip minWidth="120">
        <template v-slot="scope">
          <div style="white-space: nowrap"></div>
          {{ scope.row.name }}
        </template>
      </el-table-column>
      <el-table-column :label="$t('modules_header_tablename')" show-overflow-tooltip minWidth="140">
        <template v-slot="scope">
          {{ scope.row.tablename }}
        </template>
      </el-table-column>
      <el-table-column :label="$t('modules_header_dataSource')" show-overflow-tooltip width="140">
        <template v-if="scope.row.source" v-slot="scope">
          <span
            @click.stop="dataSourceFn(scope.row)"
            :title="scope.row.source.name"
            style="cursor: pointer; color: #2c65ff"
            >{{ scope.row.source.name }}({{
              $t('modules_status_' + (scope.row.source && scope.row.source.status))
            }})</span
          >
        </template>
      </el-table-column>
      <el-table-column :label="$t('modules_header_status')" width="110">
        <template #default="{ row }">
          <span :class="['status-' + row.status, 'status-block', 'mr-2']">
            {{ $t('modules_' + row.status) }}
          </span>
        </template>
      </el-table-column>
      <el-table-column :label="$t('modules_header_basePath')" show-overflow-tooltip>
        <template v-slot="scope">
          {{ scope.row.basePath }}
        </template>
      </el-table-column>
      <el-table-column :label="$t('public_version')">
        <template v-slot="scope">
          {{ scope.row.apiVersion }}
        </template>
      </el-table-column>
      <el-table-column :label="$t('modules_header_classifications')">
        <template v-if="scope.row.listtags" v-slot="scope">
          <div v-for="item in scope.row.listtags" :key="item.value">
            {{ item.value }}
          </div>
        </template>
      </el-table-column>
      <el-table-column :label="$t('modules_header_username')">
        <template v-slot="scope">
          {{ scope.row.user }}
        </template>
      </el-table-column>
      <el-table-column :label="$t('public_update_time')" prop="last_updated" sortable="custom" width="140">
        <template v-slot="scope">
          {{ scope.row.lastUpdatedFmt }}
        </template>
      </el-table-column>
      <el-table-column :label="$t('public_operation')" width="260" fixed="right">
        <template v-slot="scope">
          <ElButton v-readonlybtn="'API_creation'" text @click="copy(scope.row)">
            {{ $t('public_button_copy') }}
          </ElButton>
          <ElDivider direction="vertical" v-readonlybtn="'API_creation'"></ElDivider>
          <!-- <ElButton v-readonlybtn="'API_data_explorer'"  text @click="toDetails(scope.row)">
                {{ $t('public_button_preview') }}
              </ElButton>
              <ElDivider direction="vertical"></ElDivider>
              <ElButton v-readonlybtn="'API_doc_&_test'"  text @click="toDocumentTest(scope.row)">
                {{ $t('modules_api_test') }}
              </ElButton>
              <ElDivider direction="vertical"></ElDivider> -->
          <ElButton
            v-readonlybtn="'API_publish'"
            v-if="scope.row.status === 'pending'"
            text
            :disabled="$disabledByPermission('API_publish_all_data', scope.row.userId)"
            @click="publish(scope.row)"
          >
            {{ $t('modules_publish_api') }}
          </ElButton>
          <ElButton
            v-else
            v-readonlybtn="'API_publish'"
            text
            :disabled="$disabledByPermission('API_publish_all_data', scope.row.userId)"
            @click="unpublish(scope.row)"
          >
            {{ $t('modules_unpublish_api') }}
          </ElButton>
          <ElDivider direction="vertical" v-readonlybtn="'API_publish'"></ElDivider>
          <ElButton v-readonlybtn="'API_edition'" text @click="edit(scope.row)">
            {{ $t('public_button_edit') }}
          </ElButton>
          <ElDivider direction="vertical" v-readonlybtn="'API_edition'"></ElDivider>
          <!-- <ElButton v-readonlybtn="'API_export'"  text @click="handleDownload(scope.row)">
                {{ $t('public_button_export') }}
              </ElButton>
              <ElDivider direction="vertical"></ElDivider> -->
          <ElButton
            v-readonlybtn="'API_delete'"
            text
            :disabled="$disabledByPermission('API_delete_all_data', scope.row.userId) || scope.row.status !== 'pending'"
            @click="remove(scope.row)"
            >{{ $t('public_button_delete') }}</ElButton
          >
          <ElDivider direction="vertical" v-readonlybtn="'API_delete'"></ElDivider>
          <ElDropdown v-show="moreAuthority" @command="handleCommand($event, scope.row)" trigger="click">
            <ElLink type="primary" class="rotate-90">
              <el-icon><el-icon-more /></el-icon>
            </ElLink>
            <template #dropdown>
              <ElDropdownMenu class="dataflow-table-more-dropdown-menu">
                <ElDropdownItem command="preview" v-readonlybtn="'API_data_explorer'"
                  >{{ $t('public_button_preview') }}
                </ElDropdownItem>
                <ElDropdownItem command="export" v-readonlybtn="'API_export'">{{
                  $t('public_button_export')
                }}</ElDropdownItem>
                <ElDropdownItem command="toDocumentTest" v-readonlybtn="'API_doc_&_test'">{{
                  $t('modules_api_test')
                }}</ElDropdownItem>
              </ElDropdownMenu>
            </template>
          </ElDropdown>
        </template>
      </el-table-column>
    </TablePage>
    <!-- 导入 -->
    <Upload :type="'api'" ref="upload"></Upload>
  </section>
</template>

<script>
import { h } from 'vue'
import dayjs from 'dayjs'
import { escapeRegExp } from 'lodash'

import { modulesApi, workerApi, metadataInstancesApi } from '@tap/api'
import { FilterBar } from '@tap/component'
import { TablePage, UploadDialog } from '@tap/business'
import { STATUS_MAP } from '../const'

export default {
  components: {
    TablePage,
    FilterBar,
    Upload: UploadDialog,
  },
  name: 'ApiPublish',
  data() {
    return {
      searchParams: {
        keyword: '',
        status: 'all',
      },
      filterItems: [],
      order: 'last_updated DESC',
      status: 'stop',
      dbOptions: [],
      statusList: [
        {
          label: this.$t('public_select_option_all'),
          value: 'all',
        },
        {
          label: this.$t('modules_active'),
          value: 'active',
        },
        {
          label: this.$t('modules_pending'),
          value: 'pending',
        },
      ],
      multipleSelection: [],
      intervalId: 0,
      moreAuthority: this.$has('API_data_explorer') || this.$has('API_doc_&_test') || this.$has('API_export'),
      // importDialogVisible: false,
      // importForm: {
      //   tag: [],
      //   fileList: [],
      //   action: '',
      //   upsert: 1,
      //   accept: '.gz'
      // },
      // classifyList: []
    }
  },
  watch: {
    '$route.query'() {
      this.table.fetch(1)
    },
  },
  created() {
    this.getWorkers()
    this.getFilterItems()
  },
  computed: {
    table() {
      return this.$refs.table
    },
    selectedRunning() {
      return this.multipleSelection.filter((v) => v.status === 'active')
    },
    selectedStopped() {
      return this.multipleSelection.filter(
        (v) => v.status === 'pending' || v.status === 'error' || v.status === 'draft',
      )
    },
  },
  methods: {
    // 重置查询条件
    reset(name) {
      if (name === 'reset') {
        this.searchParams = {
          keyword: '',
          status: '',
        }
      }
      this.table.fetch(1)
    },
    // 获取数据
    getData({ page, tags }) {
      let { current, size } = page
      let { keyword, status } = this.searchParams
      let where = {}
      let fields = {
        apiVersion: true,
        basePath: true,
        connection: true,
        datasource: true,
        description: true,
        id: true,
        status: true,
        tablename: true,
        user_id: true,
        last_updated: true,
        listtags: true,
        name: true,
        'source._id': true,
        'source.user_id': true,
      }
      if (keyword && keyword.trim()) {
        let filterObj = { like: escapeRegExp(keyword), options: 'i' }
        where.or = [{ basePath: filterObj }, { description: filterObj }]
      }
      status && (where.status = status)

      if (tags && tags.length) {
        where['listtags.id'] = {
          in: tags,
        }
      }
      let filter = {
        order: this.order,
        limit: size,
        fields: fields,
        skip: (current - 1) * size,
        where,
      }
      return modulesApi
        .get({
          filter: JSON.stringify(filter),
        })
        .then((data) => {
          return {
            total: data?.total,
            data:
              data?.items?.map((item) => {
                item.lastUpdatedFmt = dayjs(item.last_updated).format('YYYY-MM-DD HH:mm:ss')
                return item
              }) || [],
          }
        })
    },
    // 获取状态
    getWorkers() {
      let where = {
        worker_type: 'api-server',
        ping_time: {
          gte: '$serverDate',
          gte_offset: 30000,
        },
      }
      let filter = {
        order: 'ping_time DESC',
        limit: 1,
        fields: {
          worker_status: true,
        },
        where,
      }
      workerApi
        .get({
          filter: JSON.stringify(filter),
        })
        .then((data) => {
          if (data?.items?.length) {
            let record = data?.items[0] || {}
            let workerStatus = record.workerStatus || record.worker_status || {}
            if (this.status !== workerStatus.status) {
              this.status = workerStatus.status
            }
          } else {
            this.status = 'stop'
          }
        })
      this.intervalId = setTimeout(this.getWorkers, 5000)
    },
    // 表格排序
    handleSortTable({ order, prop }) {
      this.order = `${order ? prop : 'last_updated'} ${order === 'ascending' ? 'ASC' : 'DESC'}`
      this.table.fetch(1)
    },
    handleSelectionChange(val) {
      this.multipleSelection = val
    },
    // 选中分类
    handleSelectTag() {
      let tagList = {}
      this.multipleSelection.forEach((row) => {
        if (row.classifications && row.classifications.length > 0) {
          tagList[row.classifications[0].id] = {
            value: row.classifications[0].value,
          }
        }
      })
      return tagList
    },
    // 数据分类查询数据
    handleOperationClassify(listtags) {
      let attributes = {
        id: this.multipleSelection.map((r) => r.id),
        listtags,
      }
      modulesApi.batchUpdateListtags(attributes).then(() => {
        this.table.fetch()
        this.$message.success(this.$t('public_message_save_ok'))
      })
      // .catch(() => {
      // })
    },
    // 状态改变查询
    statusChange() {
      this.table.fetch(1)
    },
    // 创建api
    openCreateDialog() {
      this.$router.push({ name: 'apiPublishCreate' })
    },
    // 预览
    preview(ids, item) {
      this.$router.push({
        name: 'apiExplorer',
        query: { id: item.basePath + '_' + item.apiVersion },
      })
    },
    // api文档及测试
    toDocumentTest(ids, item) {
      this.$router.push({
        name: 'apiDocAndTest',
        query: { id: item.basePath + '_' + item.apiVersion },
      })
    },
    // 发布api
    publish(item) {
      this.$confirm(this.$t('modules_sure') + this.$t('modules_publish_api'), this.$t('modules_publish_api'), {
        type: 'warning',
        closeOnClickModal: false,
      }).then((resFlag) => {
        if (!resFlag) {
          return
        }
        let parmas = {
          status: 'active',
          id: item.id,
          tablename: item.tablename,
        }
        modulesApi.patch(parmas).then(() => {
          this.$message.success(this.$t('modules_active'))
          this.table.fetch()
        })
        // .catch(() => {
        //   this.$message.error(this.$t('modules_status_deploy_fail'))
        // })
      })
    },
    // 取消发布
    unpublish(item) {
      this.$confirm(this.$t('modules_sure') + this.$t('modules_unpublish_api'), this.$t('modules_unpublish_api'), {
        type: 'warning',
        closeOnClickModal: false,
      }).then((resFlag) => {
        if (!resFlag) {
          return
        }
        let parmas = {
          status: 'pending',
          id: item.id,
          tablename: item.tablename,
        }
        modulesApi.patch(parmas).then(() => {
          this.$message.success(this.$t('modules_pending'))
          this.table.fetch()
        })
        // .catch(() => {
        //   this.$message.error(this.$t('modules_cancel_failed'))
        // })
      })
    },
    // 编辑
    edit(item) {
      this.$router.push({
        name: 'apiPublishEdit',
        query: { id: item.id, name: item.table_name },
        params: {
          id: item.id,
        },
      })
    },
    // 删除列表
    remove(item) {
      let message = h('p', [this.$t('public_message_delete_confirm') + ' ' + item.name])
      this.$confirm(message, {
        type: 'warning',
      }).then((resFlag) => {
        if (!resFlag) {
          return
        }
        modulesApi.delete(item.id, item.name).then(() => {
          this.$message.success(this.$t('public_message_delete_ok'))
          this.table.fetch()
        })
        // .catch(() => {
        //   this.$message.info(this.$t('public_message_delete_fail'))
        // })
      })
    },
    // 批量取消和批量发布
    batch(action) {
      if (!action) return

      let text = action === 'active' ? this.$t('modules_releasefb') : this.$t('modules_releasecancel')
      let jobs = action === 'active' ? this.selectedStopped : this.selectedRunning
      let tableNameData = jobs.map((item) => {
        return item.tablename
      })
      let message = h('p', [text + ' ', h('div', { style: { color: '#409EFF' } }, tableNameData.join(', '))])
      let title = action === 'active' ? this.$t('modules_allarelease') : this.$t('modules_allacancel')
      this.$confirm(message, title, {
        type: 'warning',
        closeOnClickModal: false,
      }).then((resFlag) => {
        if (!resFlag) {
          return
        }
        let modulesData = []
        jobs.forEach((item) => {
          let data =
            action === 'active'
              ? {
                  id: item.id,
                  status: 'active',
                  connectorStopped: false,
                  transformerStopped: false,
                }
              : {
                  id: item.id,
                  status: 'pending',
                }
          modulesData.push(modulesApi.patch(data))
        })

        Promise.all(modulesData).then((data) => {
          let successResults = data?.filter((rs) => rs) || []
          if (successResults.length === jobs.length) {
            this.table.fetch()
            this.$message.success(this.$t('public_message_save_ok'))
          } else {
            this.$message.error(this.$t('public_message_save_fail'))
          }
        })
      })
    },
    // 跳转数据源
    dataSourceFn(data) {
      if (data.source) {
        let routeUrl = this.$router.resolve({
          name: 'connectionsEdit',
          params: { id: data.source.id },
          query: { databaseType: data.source.database_type },
        })
        window.open(routeUrl.href, '_blank')
      }
    },
    // 导入按钮
    importFile() {
      this.$refs.upload.show()
      // this.importDialogVisible = true
      // this.getClassify()
      // this.$router.push('/upload?type=api')
    },
    // 批量导出
    exportFile() {
      let id = []
      id = this.multipleSelection.map((v) => {
        return v.id
      })
      let where = {
        _id: {
          in: id,
        },
      }
      metadataInstancesApi.download(where, 'Modules')
    },
    // 单个导出
    export(ids, item) {
      let where = {
        _id: {
          in: [item.id],
        },
      }
      metadataInstancesApi.download(where, 'Modules')
    },
    // 复制
    copy(item) {
      let parmas = {
        uri: `${item.id}/copy`,
        headers: { 'lconname-name': item.basePath },
      }
      modulesApi.post(parmas, { 'lconname-name': item.basePath }).then(() => {
        this.$message.success(this.$t('public_message_copy_success'))
        this.table.fetch()
      })
      // .catch(() => {
      // })
    },
    getFilterItems() {
      this.filterItems = [
        {
          label: this.$t('public_type'),
          key: 'status',
          type: 'select-inner',
          items: this.statusList,
          selectedWidth: '200px',
        },
        {
          placeholder: this.$t('modules_name_placeholder'),
          key: 'keyword',
          type: 'input',
        },
      ]
    },
    handleCommand(command, node) {
      let ids = []
      if (node) {
        ids = [node.id]
      } else {
        ids = this.multipleSelection.map((item) => item.id)
      }
      this[command](ids, node)
    },
    getStatus(type) {
      return STATUS_MAP[type] || '-'
    },
  },
  beforeUnmount() {
    if (this.intervalId) {
      clearTimeout(this.intervalId)
    }
  },
}
</script>

<style lang="scss" scoped>
.modules-list-wrap {
  height: 100%;
  .modules-list {
    .search-bar {
      display: flex;
      flex-direction: row;
      .search-status {
        line-height: 34px;
        .status-text {
          display: inline-block;
          font-weight: bold;
          height: 25px;
          padding: 0 10px;
          line-height: 25px;
          border-radius: 2px;
        }
      }

      .deploying,
      .running,
      .restart,
      .starting {
        color: #44a501;
        background-color: #c4f3cb;
      }
      .deploy_fail,
      .stop {
        color: #d44d4d;
        background-color: #ffecec;
      }
    }
    .btn + .btn {
      margin-left: 5px;
    }
    .btn {
      // padding: 7px;
      // background: map.get($bgColor, main);
      i.iconfont {
        font-size: 12px;
      }
      &.btn-dropdowm {
        margin-left: 5px;
      }
      &.btn-create {
        margin-left: 10px;
      }
    }
    .modules-name {
      .name {
        color: map.get($color, primary);
        a {
          color: inherit;
          cursor: pointer;
        }
      }
      .name:hover {
        text-decoration: underline;
      }
      .tag {
        margin-left: 5px;
        color: map.get($fontColor, light);
        background: map.get($bgColor, main);
        border: 1px solid #dedee4;
      }
      .parent {
        color: map.get($fontColor, slight);
      }
    }
  }
}
</style>

<style lang="scss">
.changeName-prompt {
  .el-message-box__header {
    padding: 15px 15px 0;
    .el-message-box__title {
      padding-left: 0;
    }
  }
}
</style>
