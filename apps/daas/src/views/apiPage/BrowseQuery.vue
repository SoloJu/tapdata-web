<template>
  <el-dialog
    width="900px"
    custom-class="browse_query"
    :before-close="handleClose"
    :title="$t('dataExplorer_query')"
    :close-on-click-modal="false"
    :append-to-body="true"
    :visible.sync="dialogFormVisible"
  >
    <div class="dialog-content">
      <!-- 过滤条件 -->
      <QueryBuild
        v-model="condition"
        :fields="fields"
        :max-level="3"
        field-label="text"
        field-value="value"
      ></QueryBuild>
      <div class="browse_button">
        <el-button type="primary" @click="handleFavorite()" size="small">
          {{ $t('dataExplorer_add_favorite') }}
        </el-button>
        <!-- <el-button type="primary" @click="search(1)" size="small">
          {{ $t('dataExplorer_query') }}
        </el-button> -->
      </div>
    </div>
    <div class="browse_rows">
      <h3 class="pb-4">{{ $t('dataExplorer_show_column') }}</h3>
      <el-checkbox :indeterminate="isIndeterminate" v-model="showAllColumn" @change="showAllColumns">全选</el-checkbox>
      <div style="margin: 15px 0"></div>
      <el-checkbox-group v-model="selectionRow" @change="handleCheckedFieldChange">
        <el-checkbox
          v-for="item in header.filter(v => v.value !== '__operation' && v.value !== '__tapd8' && v.value !== '_id')"
          :label="item.text"
          :key="item.value"
          >{{ item.text }}</el-checkbox
        >
      </el-checkbox-group>
    </div>

    <div slot="footer" class="dialog-footer">
      <el-button class="cancel" @click="handleClose()" size="small">
        {{ $t('message.cancel') }}
      </el-button>
      <el-button type="primary" @click="save()" size="small">{{ $t('message.save') }}</el-button>
    </div>
  </el-dialog>
</template>

<script>
import QueryBuild from '@/components/QueryBuild'
export default {
  name: 'BrowseQuery',
  components: { QueryBuild },
  props: {
    fieldData: {
      required: true,
      value: Array
    },
    header: {
      required: true,
      value: Array
    },
    conditionData: {
      required: true,
      value: Object
    },
    dialogVisible: {
      required: true,
      value: Boolean
    }
  },
  data() {
    return {
      dialogFormVisible: this.dialogVisible || false,
      condition: null,
      isIndeterminate: true,
      showAllColumn: true,
      selectionRow: []
    }
  },
  created() {
    this.condition = this.conditionData
    this.fieldData.forEach(v => {
      if (v.show) {
        this.selectionRow.push(v.value)
      }
    })
  },
  computed: {
    fields() {
      let _this = this
      let fieldData = _this.fieldData.map(item => {
        if (item) {
          item.field_name = item.alias_name ? item.alias_name + ' ( ' + item.field_name + ' ) ' : item.field_name
          item.javaType = item.data_type || item.javaType
          return item
        }
      })
      return fieldData
    }
  },
  watch: {
    'model.requiredQueryField'() {
      this.handlerQueryField()
    }
  },
  methods: {
    // 全选
    showAllColumns(val) {
      this.selectionRow = val
        ? this.fields.map(item => {
            return item.value
          })
        : []
      this.isIndeterminate = false
      this.fields.forEach(item => (item.show = true))
      // setTimeout(() => {
      //   this.querysavefn()
      // }, 2000)
    },
    // 显示列选中
    handleCheckedFieldChange(value) {
      let checkedCount = value.length
      this.showAllColumn = checkedCount === this.fields.length
      this.isIndeterminate = checkedCount > 0 && checkedCount < this.fields.length
      this.fields.forEach(v => {
        if (value.includes(v.value)) {
          v.show = true
        }
      })
      // setTimeout(() => {
      //   this.querysavefn()
      // }, 2000)
    },
    // 保存
    save() {
      this.dialogFormVisible = false
      this.$emit('backShowColumn', this.selectionRow, this.condition)
      this.$emit('backDialogVisible', false)
    },

    // 收藏
    handleFavorite() {
      this.$prompt('', this.$t('connection.rename'), {
        customClass: 'changeName-prompt',
        inputValue: this.favoriteName,
        beforeClose: (action, instance, done) => {
          let exists = false
          if (action === 'confirm') {
            instance.confirmButtonLoading = true

            this.$api('users')
              .get()
              .then(res => {
                if (res) {
                  let collect = res.data.favorites.filter(v => v.meta.title === this.favoriteName)
                  exists = collect.length > 0
                }
                if (exists) {
                  this.$message.error('dataExplorer_exists')
                }
                // let collection = this.collections.filter(v => v.value === this.collection)
                // let fields = {}
                // this.fieldData.forEach(h => {
                //   fields[h.value] = h.show
                // })
                // this.$emit('addFavorite', {
                //   name: 'dataExplorer',
                //   query: {
                //     apiServer: 'apiServerId',
                //     collection: collection,
                //     condition: JSON.stringify(this.condition),
                //     sortBy: this.pagination.sortBy,
                //     fields: JSON.stringify(fields)
                //   },
                //   meta: {
                //     title: this.favoriteName + ''
                //   }
                // })
                done()
              })
              .finally(() => {
                instance.confirmButtonLoading = false
              })
          } else {
            done()
          }
        }
      })
    },
    // // 查询
    // search() {
    //   this.$emit('backSearch')
    // },
    // 查询条件
    serializationToRestFilter(key, val) {
      if (typeof val === 'object') {
        if (Array.isArray(val)) {
          let result = []
          for (let i = 0; i < val.length; i++) result.push(this.serializationToRestFilter(`${key}[${i}]`, val[i]))
          return result.join('&')
        } else {
          let result = []
          for (let name in val) {
            if (name && val.hasOwnProperty(name)) {
              let temp = this.serializationToRestFilter(`${key}[${name}]`, val[name])
              if (temp) result.push(temp)
            }
          }
          return result.join('&')
        }
      } else {
        return `${key}=${typeof val === 'string' ? val.trim() : val}`
      }
    },
    // 关闭弹窗
    handleClose() {
      this.dialogFormVisible = false
      this.$emit('backDialogVisible', false)
    }
  }
}
</script>

<style lang="scss">
.browse_query {
  height: 90%;
  margin: 50px auto 0 !important;
  overflow: hidden;
  .el-dialog__body {
    height: calc(100% - 126px);
    padding: 10px 20px 0;
    overflow-y: auto;
    .el-form-item {
      margin-bottom: 10px;
    }
  }
  .browse_rows {
    padding-top: 10px;
  }
  .browse_button {
    padding-top: 10px;
    text-align: right;
  }
}
</style>
